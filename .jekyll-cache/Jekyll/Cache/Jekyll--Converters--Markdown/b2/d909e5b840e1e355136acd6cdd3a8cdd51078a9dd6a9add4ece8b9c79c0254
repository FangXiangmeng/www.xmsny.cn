I"ŠW<!--more-->
<p>æœ¬æ–‡å°†å‘å±•ç¤ºå¦‚ä½•é…ç½®å®¹å™¨çš„å­˜æ´»å’Œå¯è¯»æ€§æ¢é’ˆã€‚</p>

<p>Kubeletä½¿ç”¨liveness probeï¼ˆå­˜æ´»æ¢é’ˆï¼‰æ¥ç¡®å®šä½•æ—¶é‡å¯å®¹å™¨ã€‚ä¾‹å¦‚ï¼Œå½“åº”ç”¨ç¨‹åºå¤„äºè¿è¡ŒçŠ¶æ€ä½†æ— æ³•åšè¿›ä¸€æ­¥æ“ä½œï¼Œlivenessæ¢é’ˆå°†æ•è·åˆ°deadlockï¼Œé‡å¯å¤„äºè¯¥çŠ¶æ€ä¸‹çš„å®¹å™¨ï¼Œä½¿åº”ç”¨ç¨‹åºåœ¨å­˜åœ¨bugçš„æƒ…å†µä¸‹ä¾ç„¶èƒ½å¤Ÿç»§ç»­è¿è¡Œä¸‹å»ï¼ˆè°çš„ç¨‹åºè¿˜æ²¡å‡ ä¸ªbugå‘¢ï¼‰ã€‚</p>

<p>Kubeletä½¿ç”¨readiness probeï¼ˆå°±ç»ªæ¢é’ˆï¼‰æ¥ç¡®å®šå®¹å™¨æ˜¯å¦å·²ç»å°±ç»ªå¯ä»¥æ¥å—æµé‡ã€‚åªæœ‰å½“Podä¸­çš„å®¹å™¨éƒ½å¤„äºå°±ç»ªçŠ¶æ€æ—¶kubeletæ‰ä¼šè®¤å®šè¯¥Podå¤„äºå°±ç»ªçŠ¶æ€ã€‚è¯¥ä¿¡å·çš„ä½œç”¨æ˜¯æ§åˆ¶å“ªäº›Podåº”è¯¥ä½œä¸ºserviceçš„åç«¯ã€‚å¦‚æœPodå¤„äºéå°±ç»ªçŠ¶æ€ï¼Œé‚£ä¹ˆå®ƒä»¬å°†ä¼šè¢«ä»serviceçš„load balancerä¸­ç§»é™¤ã€‚</p>

<h2 id="å®šä¹‰-livenesså‘½ä»¤">å®šä¹‰ livenesså‘½ä»¤</h2>
<p>è®¸å¤šé•¿æ—¶é—´è¿è¡Œçš„åº”ç”¨ç¨‹åºæœ€ç»ˆä¼šè½¬æ¢åˆ°brokençŠ¶æ€ï¼Œé™¤éé‡æ–°å¯åŠ¨ï¼Œå¦åˆ™æ— æ³•æ¢å¤ã€‚Kubernetesæä¾›äº†liveness probeæ¥æ£€æµ‹å’Œè¡¥æ•‘è¿™ç§æƒ…å†µã€‚
åœ¨æœ¬æ¬¡ç»ƒä¹ å°†åŸºäº gcr.io/google_containers/busyboxé•œåƒåˆ›å»ºè¿è¡Œä¸€ä¸ªå®¹å™¨çš„Podã€‚ä»¥ä¸‹æ˜¯Podçš„é…ç½®æ–‡ä»¶exec-liveness.yamlï¼š</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">test</span><span class="pi">:</span> <span class="s">liveness</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">liveness-exec</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">liveness</span>
    <span class="na">args</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">/bin/sh</span>
    <span class="pi">-</span> <span class="s">-c</span>
    <span class="pi">-</span> <span class="s">touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep </span><span class="m">600</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">gcr.io/google_containers/busybox</span>
    <span class="na">livenessProbe</span><span class="pi">:</span>
      <span class="na">exec</span><span class="pi">:</span>
        <span class="na">command</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">cat</span>
        <span class="pi">-</span> <span class="s">/tmp/healthy</span>
      <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">5</span>
      <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">5</span>
</code></pre></div></div>

<p>è¯¥é…ç½®æ–‡ä»¶ç»™Podé…ç½®äº†ä¸€ä¸ªå®¹å™¨ã€‚periodSeconds è§„å®škubeletè¦æ¯éš”5ç§’æ‰§è¡Œä¸€æ¬¡liveness probeã€‚ initialDelaySeconds å‘Šè¯‰kubeletåœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œprobeä¹‹å‰è¦çš„ç­‰å¾…5ç§’é’Ÿã€‚æ¢é’ˆæ£€æµ‹å‘½ä»¤æ˜¯åœ¨å®¹å™¨ä¸­æ‰§è¡Œ cat /tmp/healthy å‘½ä»¤ã€‚å¦‚æœå‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼Œå°†è¿”å›0ï¼Œkubeletå°±ä¼šè®¤ä¸ºè¯¥å®¹å™¨æ˜¯æ´»ç€çš„å¹¶ä¸”å¾ˆå¥åº·ã€‚å¦‚æœè¿”å›é0å€¼ï¼Œkubeletå°±ä¼šæ€æ‰è¿™ä¸ªå®¹å™¨å¹¶é‡å¯å®ƒã€‚</p>

<p>å®¹å™¨å¯åŠ¨æ—¶ï¼Œæ‰§è¡Œè¯¥å‘½ä»¤ï¼š</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/bin/sh <span class="nt">-c</span> <span class="s2">"touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600"</span>
</code></pre></div></div>
<p>åœ¨å®¹å™¨ç”Ÿå‘½çš„æœ€åˆ30ç§’å†…æœ‰ä¸€ä¸ª /tmp/healthy æ–‡ä»¶ï¼Œåœ¨è¿™30ç§’å†… cat /tmp/healthyå‘½ä»¤ä¼šè¿”å›ä¸€ä¸ªæˆåŠŸçš„è¿”å›ç ã€‚30ç§’åï¼Œ cat /tmp/healthy å°†è¿”å›å¤±è´¥çš„è¿”å›ç ã€‚</p>

<p>åˆ›å»ºPodï¼š</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> https://k8s.io/docs/tasks/configure-pod-container/exec-liveness.yaml
</code></pre></div></div>
<p>åœ¨30ç§’å†…ï¼ŒæŸ¥çœ‹Podçš„eventï¼š</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl describe pod liveness-exec
ç»“æœæ˜¾ç¤ºæ²¡æœ‰å¤±è´¥çš„liveness probeï¼š
FirstSeen    LastSeen    Count   From            SubobjectPath           Type        Reason      Message
<span class="nt">---------</span> <span class="nt">--------</span>    <span class="nt">-----</span>   <span class="nt">----</span>            <span class="nt">-------------</span>           <span class="nt">--------</span>    <span class="nt">------</span>      <span class="nt">-------</span>
24s       24s     1   <span class="o">{</span>default-scheduler <span class="o">}</span>                    Normal      Scheduled   Successfully assigned liveness-exec to worker0
23s       23s     1   <span class="o">{</span>kubelet worker0<span class="o">}</span>   spec.containers<span class="o">{</span>liveness<span class="o">}</span>   Normal      Pulling     pulling image <span class="s2">"gcr.io/google_containers/busybox"</span>
23s       23s     1   <span class="o">{</span>kubelet worker0<span class="o">}</span>   spec.containers<span class="o">{</span>liveness<span class="o">}</span>   Normal      Pulled      Successfully pulled image <span class="s2">"gcr.io/google_containers/busybox"</span>
23s       23s     1   <span class="o">{</span>kubelet worker0<span class="o">}</span>   spec.containers<span class="o">{</span>liveness<span class="o">}</span>   Normal      Created     Created container with docker <span class="nb">id </span>86849c15382e<span class="p">;</span> Security:[seccomp<span class="o">=</span>unconfined]
23s       23s     1   <span class="o">{</span>kubelet worker0<span class="o">}</span>   spec.containers<span class="o">{</span>liveness<span class="o">}</span>   Normal      Started     Started container with docker <span class="nb">id </span>86849c15382e
</code></pre></div></div>
<p>å¯åŠ¨35ç§’åï¼Œå†æ¬¡æŸ¥çœ‹podçš„eventï¼š</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl describe pod liveness-exec
åœ¨æœ€ä¸‹é¢æœ‰ä¸€æ¡ä¿¡æ¯æ˜¾ç¤ºliveness probeå¤±è´¥ï¼Œå®¹å™¨è¢«åˆ æ‰å¹¶é‡æ–°åˆ›å»ºã€‚
FirstSeen LastSeen    Count   From            SubobjectPath           Type        Reason      Message
<span class="nt">---------</span> <span class="nt">--------</span>    <span class="nt">-----</span>   <span class="nt">----</span>            <span class="nt">-------------</span>           <span class="nt">--------</span>    <span class="nt">------</span>      <span class="nt">-------</span>
37s       37s     1   <span class="o">{</span>default-scheduler <span class="o">}</span>                    Normal      Scheduled   Successfully assigned liveness-exec to worker0
36s       36s     1   <span class="o">{</span>kubelet worker0<span class="o">}</span>   spec.containers<span class="o">{</span>liveness<span class="o">}</span>   Normal      Pulling     pulling image <span class="s2">"gcr.io/google_containers/busybox"</span>
36s       36s     1   <span class="o">{</span>kubelet worker0<span class="o">}</span>   spec.containers<span class="o">{</span>liveness<span class="o">}</span>   Normal      Pulled      Successfully pulled image <span class="s2">"gcr.io/google_containers/busybox"</span>
36s       36s     1   <span class="o">{</span>kubelet worker0<span class="o">}</span>   spec.containers<span class="o">{</span>liveness<span class="o">}</span>   Normal      Created     Created container with docker <span class="nb">id </span>86849c15382e<span class="p">;</span> Security:[seccomp<span class="o">=</span>unconfined]
36s       36s     1   <span class="o">{</span>kubelet worker0<span class="o">}</span>   spec.containers<span class="o">{</span>liveness<span class="o">}</span>   Normal      Started     Started container with docker <span class="nb">id </span>86849c15382e
2s        2s      1   <span class="o">{</span>kubelet worker0<span class="o">}</span>   spec.containers<span class="o">{</span>liveness<span class="o">}</span>   Warning     Unhealthy   Liveness probe failed: <span class="nb">cat</span>: can<span class="s1">'t open '</span>/tmp/healthy<span class="s1">': No such file or directory
</span></code></pre></div></div>
<p>å†ç­‰30ç§’ï¼Œç¡®è®¤å®¹å™¨å·²ç»é‡å¯ï¼š</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl get pod liveness-exec
ä»è¾“å‡ºç»“æœæ¥RESTARTSå€¼åŠ 1äº†ã€‚
NAME            READY     STATUS    RESTARTS   AGE
liveness-exec   1/1       Running   1          1m
</code></pre></div></div>
<h2 id="å®šä¹‰ä¸€ä¸ªliveness-httpè¯·æ±‚">å®šä¹‰ä¸€ä¸ªliveness HTTPè¯·æ±‚</h2>
<p>æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨HTTP GETè¯·æ±‚ä½œä¸ºliveness probeã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªåŸºäº<code class="highlighter-rouge">gcr.io/google_containers/liveness</code>é•œåƒè¿è¡Œäº†ä¸€ä¸ªå®¹å™¨çš„Podçš„ä¾‹å­http-liveness.yamlï¼š</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">test</span><span class="pi">:</span> <span class="s">liveness</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">liveness-http</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">liveness</span>
    <span class="na">args</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">/server</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">gcr.io/google_containers/liveness</span>
    <span class="na">livenessProbe</span><span class="pi">:</span>
      <span class="na">httpGet</span><span class="pi">:</span>
        <span class="na">path</span><span class="pi">:</span> <span class="s">/healthz</span>
        <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
        <span class="na">httpHeaders</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">X-Custom-Header</span>
            <span class="na">value</span><span class="pi">:</span> <span class="s">Awesome</span>
      <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">3</span>
      <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">3</span>
</code></pre></div></div>
<p>è¯¥é…ç½®æ–‡ä»¶åªå®šä¹‰äº†ä¸€ä¸ªå®¹å™¨ï¼ŒlivenessProbe æŒ‡å®škubeleteéœ€è¦æ¯éš”3ç§’æ‰§è¡Œä¸€æ¬¡liveness probeã€‚initialDelaySeconds æŒ‡å®škubeletåœ¨è¯¥æ‰§è¡Œç¬¬ä¸€æ¬¡æ¢æµ‹ä¹‹å‰éœ€è¦ç­‰å¾…3ç§’é’Ÿã€‚è¯¥æ¢é’ˆå°†å‘å®¹å™¨ä¸­çš„serverçš„8080ç«¯å£å‘é€ä¸€ä¸ªHTTP GETè¯·æ±‚ã€‚å¦‚æœserverçš„/healthzè·¯å¾„çš„handlerè¿”å›ä¸€ä¸ªæˆåŠŸçš„è¿”å›ç ï¼Œkubeletå°±ä¼šè®¤å®šè¯¥å®¹å™¨æ˜¯æ´»ç€çš„å¹¶ä¸”å¾ˆå¥åº·ã€‚å¦‚æœè¿”å›å¤±è´¥çš„è¿”å›ç ï¼Œkubeletå°†æ€æ‰è¯¥å®¹å™¨å¹¶é‡å¯å®ƒã€‚
ä»»ä½•å¤§äº200å°äº400çš„è¿”å›ç éƒ½ä¼šè®¤å®šæ˜¯æˆåŠŸçš„è¿”å›ç ã€‚å…¶ä»–è¿”å›ç éƒ½ä¼šè¢«è®¤ä¸ºæ˜¯å¤±è´¥çš„è¿”å›ç ã€‚
æŸ¥çœ‹è¯¥serverçš„æºç ï¼šserver.go.
æœ€å¼€å§‹çš„10ç§’è¯¥å®¹å™¨æ˜¯æ´»ç€çš„ï¼Œ <code class="highlighter-rouge">/healthz handler</code>è¿”å›200çš„çŠ¶æ€ç ã€‚è¿™ä¹‹åå°†è¿”å›500çš„è¿”å›ç ã€‚</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">http</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s">"/healthz"</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">w</span> <span class="n">http</span><span class="o">.</span><span class="n">ResponseWriter</span><span class="p">,</span> <span class="n">r</span> <span class="o">*</span><span class="n">http</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">duration</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Sub</span><span class="p">(</span><span class="n">started</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">duration</span><span class="o">.</span><span class="n">Seconds</span><span class="p">()</span> <span class="o">&gt;</span> <span class="m">10</span> <span class="p">{</span>
        <span class="n">w</span><span class="o">.</span><span class="n">WriteHeader</span><span class="p">(</span><span class="m">500</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">Write</span><span class="p">([]</span><span class="kt">byte</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"error: %v"</span><span class="p">,</span> <span class="n">duration</span><span class="o">.</span><span class="n">Seconds</span><span class="p">())))</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">w</span><span class="o">.</span><span class="n">WriteHeader</span><span class="p">(</span><span class="m">200</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">Write</span><span class="p">([]</span><span class="kt">byte</span><span class="p">(</span><span class="s">"ok"</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">})</span>
</code></pre></div></div>
<p>å®¹å™¨å¯åŠ¨3ç§’åï¼Œkubeletå¼€å§‹æ‰§è¡Œå¥åº·æ£€æŸ¥ã€‚ç¬¬ä¸€æ¬¡å¥åº·ç›‘æµ‹ä¼šæˆåŠŸï¼Œä½†æ˜¯10ç§’åï¼Œå¥åº·æ£€æŸ¥å°†å¤±è´¥ï¼Œkubeletå°†æ€æ‰å’Œé‡å¯å®¹å™¨ã€‚
åˆ›å»ºä¸€ä¸ªPodæ¥æµ‹è¯•ä¸€ä¸‹HTTP livenessæ£€æµ‹ï¼š</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create <span class="nt">-f</span> https://k8s.io/docs/tasks/configure-pod-container/http-liveness.yaml
After 10 seconds, view Pod events to verify that liveness probes have failed and the Container has been restarted:
</code></pre></div></div>
<p>10ç§’åï¼ŒæŸ¥çœ‹Podçš„eventï¼Œç¡®è®¤liveness probeå¤±è´¥å¹¶é‡å¯äº†å®¹å™¨ã€‚</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl describe pod liveness-http
</code></pre></div></div>

<h2 id="å®šä¹‰tcp-livenessæ¢é’ˆ">å®šä¹‰TCP livenessæ¢é’ˆ</h2>
<p>ç¬¬ä¸‰ç§liveness probeä½¿ç”¨TCP Socketã€‚ ä½¿ç”¨æ­¤é…ç½®ï¼Œkubeletå°†å°è¯•åœ¨æŒ‡å®šç«¯å£ä¸Šæ‰“å¼€å®¹å™¨çš„å¥—æ¥å­—ã€‚ å¦‚æœå¯ä»¥å»ºç«‹è¿æ¥ï¼Œå®¹å™¨è¢«è®¤ä¸ºæ˜¯å¥åº·çš„ï¼Œå¦‚æœä¸èƒ½å°±è®¤ä¸ºæ˜¯å¤±è´¥çš„ã€‚</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Pod</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">goproxy</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">goproxy</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">containers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">goproxy</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">gcr.io/google_containers/goproxy:0.1</span>
    <span class="na">ports</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
    <span class="na">readinessProbe</span><span class="pi">:</span>
      <span class="na">tcpSocket</span><span class="pi">:</span>
        <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
      <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">5</span>
      <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">10</span>
    <span class="na">livenessProbe</span><span class="pi">:</span>
      <span class="na">tcpSocket</span><span class="pi">:</span>
        <span class="na">port</span><span class="pi">:</span> <span class="m">8080</span>
      <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">15</span>
      <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">20</span>
</code></pre></div></div>
<p>å¦‚æ‚¨æ‰€è§ï¼ŒTCPæ£€æŸ¥çš„é…ç½®ä¸HTTPæ£€æŸ¥éå¸¸ç›¸ä¼¼ã€‚ æ­¤ç¤ºä¾‹åŒæ—¶ä½¿ç”¨äº†readinesså’Œliveness probeã€‚ å®¹å™¨å¯åŠ¨å5ç§’é’Ÿï¼Œkubeletå°†å‘é€ç¬¬ä¸€ä¸ªreadiness probeã€‚ è¿™å°†å°è¯•è¿æ¥åˆ°ç«¯å£8080ä¸Šçš„goproxyå®¹å™¨ã€‚å¦‚æœæ¢æµ‹æˆåŠŸï¼Œåˆ™è¯¥podå°†è¢«æ ‡è®°ä¸ºå°±ç»ªã€‚Kubeletå°†æ¯éš”10ç§’é’Ÿæ‰§è¡Œä¸€æ¬¡è¯¥æ£€æŸ¥ã€‚</p>

<p>é™¤äº†<code class="highlighter-rouge">readiness probe</code>ä¹‹å¤–ï¼Œè¯¥é…ç½®è¿˜åŒ…æ‹¬<code class="highlighter-rouge">liveness probe</code>ã€‚ å®¹å™¨å¯åŠ¨15ç§’åï¼Œkubeletå°†è¿è¡Œç¬¬ä¸€ä¸ªliveness probeã€‚ å°±åƒreadiness probeä¸€æ ·ï¼Œè¿™å°†å°è¯•è¿æ¥åˆ°goproxyå®¹å™¨ä¸Šçš„8080ç«¯å£ã€‚å¦‚æœliveness probeå¤±è´¥ï¼Œå®¹å™¨å°†é‡æ–°å¯åŠ¨ã€‚</p>

<p><strong>ä½¿ç”¨å‘½åçš„ç«¯å£</strong>
å¯ä»¥ä½¿ç”¨å‘½åçš„ContainerPortä½œä¸ºHTTPæˆ–TCP livenessæ£€æŸ¥ï¼š</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">ports</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">liveness-port</span>
  <span class="na">containerPort</span><span class="pi">:</span> <span class="m">8080</span>
  <span class="na">hostPort</span><span class="pi">:</span> <span class="m">8080</span>

<span class="na">livenessProbe</span><span class="pi">:</span>
  <span class="na">httpGet</span><span class="pi">:</span>
  <span class="na">path</span><span class="pi">:</span> <span class="s">/healthz</span>
  <span class="na">port</span><span class="pi">:</span> <span class="s">liveness-port</span>
</code></pre></div></div>

<h2 id="å®šä¹‰readinessæ¢é’ˆ">å®šä¹‰readinessæ¢é’ˆ</h2>
<p>æœ‰æ—¶ï¼Œåº”ç”¨ç¨‹åºæš‚æ—¶æ— æ³•å¯¹å¤–éƒ¨æµé‡æä¾›æœåŠ¡ã€‚ ä¾‹å¦‚ï¼Œåº”ç”¨ç¨‹åºå¯èƒ½éœ€è¦åœ¨å¯åŠ¨æœŸé—´åŠ è½½å¤§é‡æ•°æ®æˆ–é…ç½®æ–‡ä»¶ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ ä¸æƒ³æ€æ­»åº”ç”¨ç¨‹åºï¼Œä½†ä½ ä¹Ÿä¸æƒ³å‘é€è¯·æ±‚ã€‚ Kubernetesæä¾›äº†readiness probeæ¥æ£€æµ‹å’Œå‡è½»è¿™äº›æƒ…å†µã€‚ Podä¸­çš„å®¹å™¨å¯ä»¥æŠ¥å‘Šè‡ªå·±è¿˜æ²¡æœ‰å‡†å¤‡ï¼Œä¸èƒ½å¤„ç†KubernetesæœåŠ¡å‘é€è¿‡æ¥çš„æµé‡ã€‚</p>

<p><code class="highlighter-rouge">Readiness probe</code>çš„é…ç½®è·Ÿ<code class="highlighter-rouge">liveness probe</code>å¾ˆåƒã€‚å”¯ä¸€çš„ä¸åŒæ˜¯ä½¿ç”¨readinessProbeè€Œä¸æ˜¯livenessProbeã€‚</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">readinessProbe</span><span class="pi">:</span>
  <span class="na">exec</span><span class="pi">:</span>
    <span class="na">command</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">cat</span>
    <span class="pi">-</span> <span class="s">/tmp/healthy</span>
  <span class="na">initialDelaySeconds</span><span class="pi">:</span> <span class="m">5</span>
  <span class="na">periodSeconds</span><span class="pi">:</span> <span class="m">5</span>
</code></pre></div></div>

<blockquote>
  <p>Readiness probeçš„HTTPå’ŒTCPçš„æ¢æµ‹å™¨é…ç½®è·Ÿliveness probeä¸€æ ·ã€‚</p>
</blockquote>

<p><code class="highlighter-rouge">Readiness</code>å’Œ<code class="highlighter-rouge">livenss probe</code>å¯ä»¥å¹¶è¡Œç”¨äºåŒä¸€å®¹å™¨ã€‚ ä½¿ç”¨ä¸¤è€…å¯ä»¥ç¡®ä¿æµé‡æ— æ³•åˆ°è¾¾æœªå‡†å¤‡å¥½çš„å®¹å™¨ï¼Œå¹¶ä¸”å®¹å™¨åœ¨å¤±è´¥æ—¶é‡æ–°å¯åŠ¨ã€‚</p>

<h2 id="é…ç½®probe">é…ç½®Probe</h2>

<p><code class="highlighter-rouge">Probe</code> ä¸­æœ‰å¾ˆå¤šç²¾ç¡®å’Œè¯¦ç»†çš„é…ç½®ï¼Œé€šè¿‡å®ƒä»¬ä½ èƒ½å‡†ç¡®çš„æ§åˆ¶livenesså’Œreadinessæ£€æŸ¥ï¼š</p>

<ul>
  <li>initialDelaySecondsï¼šå®¹å™¨å¯åŠ¨åç¬¬ä¸€æ¬¡æ‰§è¡Œæ¢æµ‹æ˜¯éœ€è¦ç­‰å¾…å¤šå°‘ç§’ã€‚\</li>
  <li>periodSecondsï¼šæ‰§è¡Œæ¢æµ‹çš„é¢‘ç‡ã€‚é»˜è®¤æ˜¯10ç§’ï¼Œæœ€å°1ç§’ã€‚\</li>
  <li>timeoutSecondsï¼šæ¢æµ‹è¶…æ—¶æ—¶é—´ã€‚é»˜è®¤1ç§’ï¼Œæœ€å°1ç§’ã€‚\</li>
  <li>successThresholdï¼šæ¢æµ‹å¤±è´¥åï¼Œæœ€å°‘è¿ç»­æ¢æµ‹æˆåŠŸå¤šå°‘æ¬¡æ‰è¢«è®¤å®šä¸ºæˆåŠŸã€‚é»˜è®¤æ˜¯1ã€‚å¯¹äºlivenesså¿…é¡»æ˜¯1ã€‚æœ€å°å€¼æ˜¯1ã€‚\</li>
  <li>failureThresholdï¼šæ¢æµ‹æˆåŠŸåï¼Œæœ€å°‘è¿ç»­æ¢æµ‹å¤±è´¥å¤šå°‘æ¬¡æ‰è¢«è®¤å®šä¸ºå¤±è´¥ã€‚é»˜è®¤æ˜¯3ã€‚æœ€å°å€¼æ˜¯1ã€‚</li>
</ul>

<p><code class="highlighter-rouge">HTTP probe</code>ä¸­å¯ä»¥ç»™ httpGetè®¾ç½®å…¶ä»–é…ç½®é¡¹ï¼š</p>

<ul>
  <li>hostï¼šè¿æ¥çš„ä¸»æœºåï¼Œé»˜è®¤è¿æ¥åˆ°podçš„IPã€‚ä½ å¯èƒ½æƒ³åœ¨http headerä¸­è®¾ç½®â€Hostâ€è€Œä¸æ˜¯ä½¿ç”¨IPã€‚\</li>
  <li>schemeï¼šè¿æ¥ä½¿ç”¨çš„schemaï¼Œé»˜è®¤HTTPã€‚\</li>
  <li>path: è®¿é—®çš„HTTP serverçš„pathã€‚\</li>
  <li>httpHeadersï¼šè‡ªå®šä¹‰è¯·æ±‚çš„headerã€‚HTTPè¿è¡Œé‡å¤çš„headerã€‚\</li>
  <li>portï¼šè®¿é—®çš„å®¹å™¨çš„ç«¯å£åå­—æˆ–è€…ç«¯å£å·ã€‚ç«¯å£å·å¿…é¡»ä»‹äº1å’Œ65535ä¹‹é—´ã€‚</li>
</ul>

<p>å¯¹äºHTTPæ¢æµ‹å™¨ï¼Œkubeletå‘æŒ‡å®šçš„è·¯å¾„å’Œç«¯å£å‘é€HTTPè¯·æ±‚ä»¥æ‰§è¡Œæ£€æŸ¥ã€‚ Kubeletå°†probeå‘é€åˆ°å®¹å™¨çš„IPåœ°å€ï¼Œé™¤éåœ°å€è¢«httpGetä¸­çš„å¯é€‰hostå­—æ®µè¦†ç›–ã€‚ åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ ä¸æƒ³è®¾ç½®ä¸»æœºå­—æ®µã€‚ æœ‰ä¸€ç§æƒ…å†µä¸‹ä½ å¯ä»¥è®¾ç½®å®ƒã€‚ å‡è®¾å®¹å™¨åœ¨127.0.0.1ä¸Šä¾¦å¬ï¼Œå¹¶ä¸”Podçš„hostNetworkå­—æ®µä¸ºtrueã€‚ ç„¶åï¼Œåœ¨httpGetä¸‹çš„hoståº”è¯¥è®¾ç½®ä¸º127.0.0.1ã€‚ å¦‚æœä½ çš„podä¾èµ–äºè™šæ‹Ÿä¸»æœºï¼Œè¿™å¯èƒ½æ˜¯æ›´å¸¸è§çš„æƒ…å†µï¼Œä½ ä¸åº”è¯¥æ˜¯ç”¨hostï¼Œè€Œæ˜¯åº”è¯¥åœ¨httpHeadersä¸­è®¾ç½®Hostå¤´ã€‚</p>

<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<p>kuberenteså®˜ç½‘çš„è¿™ç¯‡æ–‡ç« <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/">Configure Liveness and Readiness Probes</a>æ¥ä¸€æ¢ç©¶ç«Ÿã€‚</p>
:ET