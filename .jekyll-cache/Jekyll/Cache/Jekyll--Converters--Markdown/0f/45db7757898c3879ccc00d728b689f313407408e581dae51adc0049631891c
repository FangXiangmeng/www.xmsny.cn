I"×<h1 id="centos74-å®‰è£…openstack-steinç‰ˆæœ¬">Centos7.4 å®‰è£…Openstack Steinç‰ˆæœ¬</h1>

<h2 id="ä¸€ç¯å¢ƒå‡†å¤‡">ä¸€ã€ç¯å¢ƒå‡†å¤‡</h2>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>å®‰è£…ç»„ä»¶ | èŠ‚ç‚¹IP | ç½‘å¡å
controller  192.168.172.179 ens160ã€ens192
computer 192.168.172.180 ens160
</code></pre></div></div>

<h2 id="äºŒç¯å¢ƒé…ç½®">äºŒã€ç¯å¢ƒé…ç½®</h2>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€ä¿®æ”¹ä¸»æœºå
hostnamectl set-hostname controller

# 2ã€å…³é—­é˜²ç«å¢™
systemctl stop firewalld.service
systemctl disable firewalld.service

# 3ã€å…³é—­SeLinux
sed -i 's#SELINUX=enforcing#SELINUX=disabled#g' /etc/selinux/config
grep -n 'SELINUX='  /etc/selinux/config

# 4ã€å®‰è£…å¸¸ç”¨çš„è½¯ä»¶åŒ…
yum install -y vim net-tools wget lrzsz tree screen lsof tcpdump nmap mlocate

# 5ã€ä¿®æ”¹hostæ–‡ä»¶
cat &gt;&gt;/etc/hosts&lt;&lt;EOF
192.168.172.179 controller
192.168.172.180 computer
EOF
</code></pre></div></div>
<blockquote>
  <p>controller&amp;computeréƒ½éœ€è¦æ‰§è¡Œã€‚æ‰§è¡Œå®Œæ¯•ä¸Šè¿°ä»£ç åï¼Œå…³é—­è¯¥è™šæ‹Ÿæœºã€‚</p>
</blockquote>

<h2 id="ä¸‰å®‰è£…åŸºç¡€æœåŠ¡">ä¸‰ã€å®‰è£…åŸºç¡€æœåŠ¡</h2>

<p>1ã€å¯ç”¨OpenStackåº“</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nb">install</span> <span class="nt">-y</span> centos-release-openstack-stein
</code></pre></div></div>
<p>2ã€å®‰è£…æ—¶é—´åŒæ­¥æœåŠ¡</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 1ã€å®‰è£…è½¯ä»¶åŒ…</span>
yum <span class="nb">install</span> <span class="nt">-y</span> chrony

<span class="c"># 2ã€å…è®¸å…¶ä»–èŠ‚ç‚¹å¯ä»¥è¿æ¥åˆ°æ§åˆ¶èŠ‚ç‚¹çš„ chrony åå°è¿›ç¨‹</span>
<span class="nb">echo</span> <span class="s1">'allow 192.168.172.0/24'</span> <span class="o">&gt;&gt;</span> /etc/chrony.conf

<span class="c"># 3ã€å¯åŠ¨ NTP æœåŠ¡å¹¶å°†å…¶é…ç½®ä¸ºéšç³»ç»Ÿå¯åŠ¨</span>
systemctl <span class="nb">enable </span>chronyd.service
systemctl start chronyd.service

<span class="c"># 4ã€è®¾ç½®æ—¶åŒº</span>
timedatectl set-timezone Asia/Shanghai

<span class="c"># 5ã€æŸ¥è¯¢æ—¶é—´</span>
timedatectl status

</code></pre></div></div>

<p>3ã€å®‰è£…MariaDB</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 1ã€å®‰è£…è½¯ä»¶åŒ…</span>
yum <span class="nb">install</span> <span class="nt">-y</span> mariadb mariadb-server MySQL-python

<span class="c"># 2ã€é…ç½®</span>
vim /etc/my.cnf.d/mariadb-server.cnf <span class="c">#åœ¨mysqldæ¨¡å—ä¸‹æ”¾å…¥ä¸€ä¸‹å‡ è¡Œ</span>
default-storage-engine <span class="o">=</span> innodb
innodb_file_per_table <span class="o">=</span> on
collation-server <span class="o">=</span> utf8_general_ci
init-connect <span class="o">=</span> <span class="s1">'SET NAMES utf8'</span>
character-set-server <span class="o">=</span> utf8

<span class="c"># 3ã€å¯åŠ¨æ•°æ®åº“æœåŠ¡ï¼Œå¹¶å°†å…¶é…ç½®ä¸ºå¼€æœºè‡ªå¯</span>
systemctl start mariadb.service
systemctl <span class="nb">enable </span>mariadb.service

<span class="c"># 4ã€å¯¹æ•°æ®åº“è¿›è¡Œå®‰å…¨åŠ å›º(è®¾ç½®rootç”¨æˆ·å¯†ç )</span>
mysql_secure_installation
</code></pre></div></div>

<p>4ã€å®‰è£…Memcache</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 1ã€å®‰è£…è½¯ä»¶åŒ…</span>
yum <span class="nb">install</span> <span class="nt">-y</span> memcached python-memcached


<span class="c"># 2ã€ä¿®æ”¹ç›‘å¬ip</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/127.0.0.1/0.0.0.0/'</span> /etc/sysconfig/memcached

<span class="c"># 3ã€å¯åŠ¨å¹¶åŠ å…¥å¼€æœºè‡ªå¯</span>
systemctl start memcached.service
systemctl <span class="nb">enable </span>memcached.service

<span class="c">#4ã€æµ‹è¯•</span>
<span class="nb">printf</span> <span class="s2">"set foo 0 0 3</span><span class="se">\r\n</span><span class="s2">bar</span><span class="se">\r\n</span><span class="s2">"</span>|nc controller 11211  <span class="c"># æ·»åŠ æ•°æ®</span>
<span class="nb">printf</span> <span class="s2">"get foo</span><span class="se">\r\n</span><span class="s2">"</span>|nc controller 11211  <span class="c"># è·å–æ•°æ®,åœ¨è®¡ç®—èŠ‚ç‚¹ä¸Šä¹Ÿæµ‹è¯•ä¸‹</span>
</code></pre></div></div>

<p>5ã€å®‰è£…rabbitmqæ¶ˆæ¯é˜Ÿåˆ—</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># 1ã€å®‰è£…</span>
yum <span class="nb">install</span> <span class="nt">-y</span> rabbitmq-server

<span class="c"># 2ã€å¯åŠ¨</span>
systemctl <span class="nb">enable </span>rabbitmq-server.service
systemctl start rabbitmq-server.service

<span class="c"># 3ã€åˆ›å»ºç”¨æˆ·</span>
rabbitmqctl add_user openstack openstack

<span class="c"># 4ã€æˆæƒ</span>
rabbitmqctl set_permissions openstack <span class="s2">".*"</span> <span class="s2">".*"</span> <span class="s2">".*"</span>

<span class="c"># 5ã€å¯ç”¨webç®¡ç†ç•Œé¢</span>
rabbitmq-plugins list  <span class="c"># æŸ¥çœ‹rabbitmqæœ‰å“ªäº›æ’ä»¶</span>
rabbitmq-plugins <span class="nb">enable </span>rabbitmq_management  <span class="c"># å¯ç”¨webç®¡ç†ç•Œé¢</span>

<span class="c"># 6ã€æµè§ˆå™¨ä¸Šç™»å½•</span>
<span class="c"># åœ¨æµè§ˆå™¨ä¸Šè¾“å…¥http://10.0.0.11:15672/</span>
<span class="c"># ç”¨æˆ·åã€å¯†ç å‡ä¸ºï¼šguestï¼ˆç¬¬ä¸€æ¬¡ç™»å½•å¿…é¡»ä½¿ç”¨è¯¥ç”¨æˆ·å¯†ç ï¼‰</span>

<span class="c"># 7ã€åœ¨æµè§ˆå™¨ä¸Šä¸ºåˆšåˆ›å»ºçš„openstackæ›´æ–°Tagsä¸ºï¼šadministrator</span>
<span class="c"># ç‚¹å‡»Admin -&gt; ç‚¹å‡»Usersåˆ—è¡¨ä¸­çš„openstack -&gt;åœ¨Update this userä¸­è¾“å…¥ä¸¤æ¬¡openstackä½œä¸ºå¯†ç (å¯†ç å¿…é¡»å†™ï¼Œå› æ­¤æˆ‘ä»¬å†™åŸå¯†ç )ï¼ŒTagsè®¾ç½®ä¸ºadministrator -&gt; ç‚¹å‡»Update user</span>
</code></pre></div></div>

<h2 id="å››æ§åˆ¶èŠ‚ç‚¹å®‰è£…keystone">å››ã€æ§åˆ¶èŠ‚ç‚¹å®‰è£…keystone</h2>
<p>åœ¨æ§åˆ¶å™¨èŠ‚ç‚¹ä¸Šå®‰è£…å’Œé…ç½®ä»£å·ä¸ºKeystoneçš„OpenStackèº«ä»½æœåŠ¡ã€‚
ä¸ºäº†å®ç°å¯ä¼¸ç¼©æ€§ï¼Œæ­¤é…ç½®éƒ¨ç½²äº†Fernetä»¤ç‰Œå’ŒApache HTTPæœåŠ¡å™¨æ¥å¤„ç†è¯·æ±‚ã€‚</p>

<h3 id="41å®‰è£…å‰æ">4.1ã€å®‰è£…å‰æ</h3>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># ä¸ºkeystoneåˆ›å»ºæ•°æ®åº“å¹¶æˆæƒ</span>
<span class="nt">--</span> 1ã€ç™»å½•æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ
mysql <span class="nt">-uroot</span> <span class="nt">-p</span>

<span class="nt">--</span> 2ã€åˆ›å»ºæ•°æ®åº“
create database keystone<span class="p">;</span>

<span class="nt">--</span> 3ã€åˆ›å»ºç”¨æˆ·å¹¶æˆæƒ
grant all privileges on keystone.<span class="k">*</span> to keystone_user@controller identified by <span class="s1">'keystone_pass'</span><span class="p">;</span>

<span class="nt">--</span> 4ã€åˆ·æ–°æƒé™
flush privileges<span class="p">;</span>

<span class="nt">--</span> 5ã€é€€å‡ºè¯¥session
quit<span class="p">;</span>
</code></pre></div></div>

<h3 id="42å®‰è£…åŠé…ç½®">4.2ã€å®‰è£…åŠé…ç½®</h3>

<p>1ã€å®‰è£…è½¯ä»¶åŒ…</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum install -y openstack-keystone httpd mod_wsgi
</code></pre></div></div>

<p>2ã€ä¿®æ”¹é…ç½®æ–‡ä»¶</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€å¤‡ä»½åŸæ–‡ä»¶
sed -i.default -e '/^#/d' -e '/^$/d' /etc/keystone/keystone.conf

# 2ã€ä¿®æ”¹æ¨¡å—å¦‚ä¸‹ï¼Œvim /etc/keystone/keystone.conf
[database]
connection = mysql+pymysql://keystone_user:keystone_pass@controller/keystone

[token]
provider = fernet
</code></pre></div></div>

<p>3ã€åŒæ­¥æ•°æ®åº“</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>su -s /bin/sh -c "keystone-manage db_sync" keystone
</code></pre></div></div>

<p>4ã€åˆå§‹åŒ–Fernetå¯†é’¥å­˜å‚¨åº“</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone
keystone-manage credential_setup --keystone-user keystone --keystone-group keystone
</code></pre></div></div>

<p>5ã€åˆ›å»ºkeystoneç®¡ç†å‘˜</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>keystone-manage bootstrap --bootstrap-password admin_pass \
  --bootstrap-admin-url http://controller:5000/v3/ \
  --bootstrap-internal-url http://controller:5000/v3/ \
  --bootstrap-public-url http://controller:5000/v3/ \
  --bootstrap-region-id RegionOne
</code></pre></div></div>

<h3 id="43é…ç½®å¹¶å¯åŠ¨apache-http-server">4.3ã€é…ç½®å¹¶å¯åŠ¨Apache HTTP server</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€é…ç½®ServerName
sed -i '/#ServerName/aServerName controller:80' /etc/httpd/conf/httpd.conf

# 2ã€è¿æ¥keystoneé…ç½®æ–‡ä»¶
ln -s /usr/share/keystone/wsgi-keystone.conf /etc/httpd/conf.d/

# 3ã€å¯åŠ¨å¹¶åŠ å…¥å¼€æœºè‡ªå¯åŠ¨
systemctl start httpd.service
systemctl enable httpd.service

# 4ã€é…ç½®ç®¡ç†å‘˜è´¦å·ç¯å¢ƒå˜é‡
export OS_USERNAME=admin
export OS_PASSWORD=admin_pass
export OS_PROJECT_NAME=admin
export OS_USER_DOMAIN_NAME=Default
export OS_PROJECT_DOMAIN_NAME=Default
export OS_AUTH_URL=http://controller:5000/v3
export OS_IDENTITY_API_VERSION=3
</code></pre></div></div>

<h3 id="44åˆ›å»ºåŸŸé¡¹ç›®ç”¨æˆ·å’Œè§’è‰²">4.4ã€åˆ›å»ºåŸŸã€é¡¹ç›®ã€ç”¨æˆ·å’Œè§’è‰²</h3>
<p>1ã€åˆ›å»ºåŸŸ</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># åˆ›å»ºä¸€ä¸ªåŸŸç¤ºä¾‹ï¼Œä¸åˆ›å»ºä¹Ÿå¯ä»¥ï¼ŒKeystoneå·²å­˜åœ¨ä¸€ä¸ªåŸŸï¼šdefault
# openstack domain create --description "An Example Domain" example
</code></pre></div></div>

<p>2ã€åˆ›å»ºæœåŠ¡é¡¹ç›®</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ä¾›glanceã€placementã€novaå’Œneutronç­‰ç»„ä»¶ä½¿ç”¨
openstack project create --domain default --description "Service Project" service
</code></pre></div></div>

<p>3ã€åˆ›å»ºå¸¸è§„ï¼ˆéç®¡ç†å‘˜ï¼‰ä»»åŠ¡åº”ä½¿ç”¨æ— ç‰¹æƒçš„é¡¹ç›®å’Œç”¨æˆ·</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€åˆ›å»ºé¡¹ç›®
openstack project create --domain default --description "Demo Project" myproject

# 2ã€åˆ›å»ºç”¨æˆ·
openstack user create --domain default --password myuser_pass myuser

# 3ã€åˆ›å»ºè§’è‰²
openstack role create myrole

# 4ã€æŠŠç”¨æˆ·å’Œè§’è‰²æ·»åŠ åˆ°é¡¹ç›®
openstack role add --project myproject --user myuser myrole
</code></pre></div></div>

<h3 id="45éªŒè¯èº«ä»½åŠå¯†ç ">4.5ã€éªŒè¯èº«ä»½åŠå¯†ç </h3>
<p>1ã€åˆ é™¤ä¸´æ—¶ç¯å¢ƒå˜é‡OS_AUTH_URLã€OS_PASSWORD</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>unset OS_AUTH_URL OS_PASSWORD
</code></pre></div></div>

<p>2ã€éªŒè¯admin,å¯†ç ä¸ºï¼šadmin_pass</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack --os-auth-url http://controller:5000/v3 \
  --os-project-domain-name Default --os-user-domain-name Default \
  --os-project-name admin --os-username admin token issue
</code></pre></div></div>

<p>3ã€éªŒè¯myuserï¼Œå¯†ç ä¸ºï¼šmyuser_pass</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack --os-auth-url http://controller:5000/v3 \
  --os-project-domain-name Default --os-user-domain-name Default \
  --os-project-name myproject --os-username myuser token issue
</code></pre></div></div>

<h3 id="46åˆ›å»ºå®¢æˆ·ç«¯ç¯å¢ƒå˜é‡è„šæœ¬">4.6ã€åˆ›å»ºå®¢æˆ·ç«¯ç¯å¢ƒå˜é‡è„šæœ¬</h3>
<p>ç”±äºä¸´æ—¶ç¯å¢ƒå˜é‡åªå­˜åœ¨æœ¬sessionï¼Œæ¯æ¬¡sessionæ–­å¼€æˆ–é‡æ–°æ‰“å¼€ä¸€ä¸ªsessionä¸´æ—¶å˜é‡éƒ½ä¼šå¤±æ•ˆï¼Œå› æ­¤å°†è¿™äº›ç¯å¢ƒå˜é‡å†™å…¥è„šæœ¬ä¸­ï¼Œéœ€è¦ç”¨åˆ°æ—¶æ‰§è¡Œä¸‹è„šæœ¬å³å¯ã€‚</p>

<p>1ã€åˆ›å»ºè„šæœ¬</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€è¿›å…¥å®¶ç›®å½•
cd ~

# 2ã€åˆ›å»ºadminç”¨æˆ·çš„OpenStackå®¢æˆ·ç«¯ç¯å¢ƒå˜é‡è„šæœ¬
cat &gt;admin-openrc&lt;&lt;EOF
export OS_PROJECT_DOMAIN_NAME=Default
export OS_USER_DOMAIN_NAME=Default
export OS_PROJECT_NAME=admin
export OS_USERNAME=admin
export OS_PASSWORD=admin_pass
export OS_AUTH_URL=http://controller:5000/v3
export OS_IDENTITY_API_VERSION=3
export OS_IMAGE_API_VERSION=2
EOF

# 3ã€åˆ›å»ºmyuserç”¨æˆ·çš„OpenStackå®¢æˆ·ç«¯ç¯å¢ƒå˜é‡è„šæœ¬
cat &gt;demo-openrc&lt;&lt;EOF
export OS_PROJECT_DOMAIN_NAME=Default
export OS_USER_DOMAIN_NAME=Default
export OS_PROJECT_NAME=myproject
export OS_USERNAME=myuser
export OS_PASSWORD=myuser_pass
export OS_AUTH_URL=http://controller:5000/v3
export OS_IDENTITY_API_VERSION=3
export OS_IMAGE_API_VERSION=2
EOF
</code></pre></div></div>

<p>2ã€éªŒè¯è„šæœ¬</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€åŠ è½½ç¯å¢ƒå˜é‡
cd ~
. admin-openrc

# 2ã€è¯·æ±‚éªŒè¯token
openstack token issue
</code></pre></div></div>
<p>èƒ½çœ‹åˆ°è¿”å›çš„tokenå°±è¯´æ˜å®‰è£…æˆåŠŸï¼Œå…·ä½“çœ‹https://docs.openstack.org/keystone/stein/install/keystone-openrc-rdo.html</p>

<h2 id="äº”æ§åˆ¶èŠ‚ç‚¹å®‰è£…glance">äº”ã€æ§åˆ¶èŠ‚ç‚¹å®‰è£…Glance</h2>
<h3 id="51å®‰è£…å‰æ">5.1ã€å®‰è£…å‰æ</h3>
<p>1ã€ä¸ºGlanceå»ºåº“å¹¶æˆæƒ</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>create database glance;
grant all privileges on glance.* to glance_user@controller identified by 'glance_pass';
flush privileges;
quit;
</code></pre></div></div>

<p>2ã€è·å–keystoneç®¡ç†å‘˜å‡­æ®</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>. admin-openrc
</code></pre></div></div>

<p>3ã€åˆ›å»ºGlanceæœåŠ¡å‡­è¯</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€ åˆ›å»ºglanceç”¨æˆ·
openstack user create --domain default --password glance_pass glance

# 2ã€å°†glanceç”¨æˆ·åŠ å…¥åˆ°serviceé¡¹ç›®å¹¶æˆäºˆadmin(ç®¡ç†å‘˜)è§’è‰²
openstack role add --project service --user glance admin

# 3ã€åˆ›å»ºglanceæœåŠ¡å®ä½“
openstack service create --name glance --description "OpenStack Image" image
</code></pre></div></div>

<p>4ã€åˆ›å»ºGlanceæœåŠ¡APIç«¯ç‚¹</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€åˆ›å»ºå…±æœ‰GlanceæœåŠ¡APIç«¯ç‚¹
openstack endpoint create --region RegionOne image public http://controller:9292

# 2ã€åˆ›å»ºç§æœ‰GlanceæœåŠ¡APIç«¯ç‚¹
openstack endpoint create --region RegionOne image internal http://controller:9292

# 3ã€åˆ›å»ºç®¡ç†GlanceæœåŠ¡APIç«¯ç‚¹
openstack endpoint create --region RegionOne image admin http://controller:9292
</code></pre></div></div>

<h3 id="52å®‰è£…åŠé…ç½®">5.2ã€å®‰è£…åŠé…ç½®</h3>
<p>1ã€å®‰è£…è½¯ä»¶åŒ…</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum install -y openstack-glance
</code></pre></div></div>

<p>2ã€ä¿®æ”¹glance-api.confé…ç½®æ–‡ä»¶</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€å¤‡ä»½åŸæ–‡ä»¶
sed -i.default -e '/^#/d' -e '/^$/d' /etc/glance/glance-api.conf

# 2ã€ä¿®æ”¹æ¨¡æ¿å¦‚ä¸‹ï¼Œvim /etc/glance/glance-api.conf
[database]
connection = mysql+pymysql://glance_user:glance_pass@controller/glance

[glance_store]
stores = file,http
default_store = file
filesystem_store_datadir = /var/lib/glance/images/

[keystone_authtoken]
www_authenticate_uri  = http://controller:5000
auth_url = http://controller:5000
memcached_servers = controller:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = glance
password = glance_pass

[paste_deploy]
flavor = keystone
</code></pre></div></div>

<p>3ã€ä¿®æ”¹glance-registry.confé…ç½®æ–‡ä»¶</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€å¤‡ä»½åŸæ–‡ä»¶
sed -i.default -e '/^#/d' -e '/^$/d' /etc/glance/glance-registry.conf

# 2ã€ä¿®æ”¹æ¨¡å—å¦‚ä¸‹ï¼Œvim /etc/glance/glance-registry.conf
[database]
connection = mysql+pymysql://glance_user:glance_pass@controller/glance

[keystone_authtoken]
www_authenticate_uri = http://controller:5000
auth_url = http://controller:5000
memcached_servers = controller:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = glance
password = glance_pass

[paste_deploy]
flavor = keystone
</code></pre></div></div>

<p>4ã€åŒæ­¥æ•°æ®</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>su -s /bin/sh -c "glance-manage db_sync" glance
</code></pre></div></div>

<h3 id="53å¯åŠ¨å¹¶åŠ å…¥å¼€å¯è‡ªå¯">5.3ã€å¯åŠ¨å¹¶åŠ å…¥å¼€å¯è‡ªå¯</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl start openstack-glance-api.service openstack-glance-registry.service
systemctl enable openstack-glance-api.service openstack-glance-registry.service
</code></pre></div></div>

<h3 id="54ä¸Šä¼ é•œåƒ">5.4ã€ä¸Šä¼ é•œåƒ</h3>
<p>1ã€ä¸‹è½½é•œåƒ</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd ~
wget http://download.cirros-cloud.net/0.4.0/cirros-0.4.0-x86_64-disk.img
</code></pre></div></div>

<p>2ã€å°†åˆšä¸‹è½½çš„é•œåƒä¸Šä¼ åˆ°glance</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€è·å–keystoneç®¡ç†å‘˜å‡­æ®
cd ~
. admin-openrc

# 2ã€ä¸Šä¼ é•œåƒ
cd ~
openstack image create "cirros" \
  --file cirros-0.4.0-x86_64-disk.img \
  --disk-format qcow2 --container-format bare \
  --public

# 3ã€æŸ¥çœ‹ä¸Šä¼ ç»“æœ
openstack image list
</code></pre></div></div>

<h2 id="å…­æ§åˆ¶èŠ‚ç‚¹å®‰è£…placement">å…­ã€æ§åˆ¶èŠ‚ç‚¹å®‰è£…Placement</h2>
<p>Placementç»„ä»¶ä»nç‰ˆå¼•å…¥ï¼Œpç‰ˆå¼ºåˆ¶ç”¨æˆ·ä½¿ç”¨ï¼Œè¯¥ç»„ä»¶çš„ä¸»è¦ä½œç”¨æ˜¯å‚ä¸ nova-scheduler é€‰æ‹©ç›®æ ‡ä¸»æœºçš„è°ƒåº¦æµç¨‹ä¸­ï¼Œè´Ÿè´£è·Ÿè¸ªè®°å½• Resource Provider çš„ Inventory å’Œ Usageï¼Œå¹¶ä½¿ç”¨ä¸åŒçš„ Resource Classes æ¥åˆ’åˆ†èµ„æºç±»å‹ï¼Œä½¿ç”¨ä¸åŒçš„ Resource Traits æ¥æ ‡è®°èµ„æºç‰¹å¾ã€‚</p>

<h3 id="61å®‰è£…å‰æ">6.1ã€å®‰è£…å‰æ</h3>
<p>1ã€ä¸ºPlacementå»ºåº“å¹¶æˆæƒ</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>create database placement;
grant all privileges on placement.* to 'placement_user'@'controller' identified by 'placement_pass';
flush privileges;
quit;
</code></pre></div></div>
<p>2ã€è·å–Keystoneç®¡ç†å‘˜å‡­æ®</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd ~
. admin-openrc
</code></pre></div></div>

<p>3ã€åˆ›å»ºPlacementæœåŠ¡å‡­è¯</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€ åˆ›å»ºplacementç”¨æˆ·,å¯†ç è®¾ç½®ä¸ºï¼šplacement_pass
openstack user create --domain default --password placement_pass placement

# 2ã€å°†ç®¡ç†å‘˜è§’è‰²æ·»åŠ éƒ½placementç”¨æˆ·å’Œserviceé¡¹ç›®ä¸­
openstack role add --project service --user placement admin

# 3ã€åˆ›å»ºplacementæœåŠ¡å®ä½“
openstack service create --name placement --description "Placement API" placement
</code></pre></div></div>

<p>4ã€åˆ›å»ºPlacementæœåŠ¡APIç«¯ç‚¹</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack endpoint create --region RegionOne placement public http://controller:8778
openstack endpoint create --region RegionOne placement internal http://controller:8778
openstack endpoint create --region RegionOne placement admin http://controller:8778
</code></pre></div></div>

<h3 id="62å®‰è£…åŠé…ç½®">6.2ã€å®‰è£…åŠé…ç½®</h3>
<p>1ã€å®‰è£…è½¯ä»¶åŒ…</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum install -y openstack-placement-api
</code></pre></div></div>

<p>2ã€ä¿®æ”¹placement.confé…ç½®æ–‡ä»¶</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€å¤‡ä»½åŸæ–‡ä»¶
sed -i.default -e '/^#/d' -e '/^$/d' /etc/placement/placement.conf

# 2ã€ä¿®æ”¹æ¨¡å—å¦‚ä¸‹ï¼Œvim /etc/placement/placement.conf
[api]
auth_strategy = keystone

[keystone_authtoken]
auth_url = http://controller:5000/v3
memcached_servers = controller:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = placement
password = placement_pass

[placement_database]
connection = mysql+pymysql://placement_user:placement_pass@controller/placement
</code></pre></div></div>

<p>3ã€åŒæ­¥æ•°æ®åº“</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>su -s /bin/sh -c "placement-manage db sync" placement
</code></pre></div></div>

<p>4ã€å…è®¸å…¶ä»–ç»„ä»¶è®¿é—®Placement API</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€ä¿®æ”¹Apache HTTP serveré…ç½®
cat &gt;&gt;/etc/httpd/conf.d/00-placement-api.conf&lt;&lt;EOF

&lt;Directory /usr/bin&gt;
   &lt;IfVersion &gt;= 2.4&gt;
      Require all granted
   &lt;/IfVersion&gt;
   &lt;IfVersion &lt; 2.4&gt;
      Order allow,deny
      Allow from all
   &lt;/IfVersion&gt;
&lt;/Directory&gt;
EOF

# 2ã€é‡å¯Apache HTTP serverä½¿ä¹‹ç”Ÿæ•ˆ
systemctl restart httpd
</code></pre></div></div>

<h3 id="63æ£€æŸ¥placementå®‰è£…ç»“æœ">6.3ã€æ£€æŸ¥Placementå®‰è£…ç»“æœ</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>placement-status upgrade check
</code></pre></div></div>

<h2 id="ä¸ƒæ§åˆ¶èŠ‚ç‚¹å®‰è£…nova">ä¸ƒã€æ§åˆ¶èŠ‚ç‚¹å®‰è£…Nova</h2>
<h3 id="71å®‰è£…å‰æ">7.1ã€å®‰è£…å‰æ</h3>
<p>1.ä¸ºNovaå»ºåº“å¹¶æˆæƒ</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€å»ºåº“
create database nova_api;
create database nova;
create database nova_cell0;

# 2ã€æˆæƒ
grant all privileges on nova_api.* to 'nova_user'@'controller' identified by 'nova_pass';
grant all privileges on nova.* to 'nova_user'@'controller' identified by 'nova_pass';
grant all privileges on nova_cell0.* to 'nova_user'@'controller' identified by 'nova_pass';

# 3ã€åˆ·æ–°æƒé™
flush privileges;
</code></pre></div></div>

<p>2ã€è·å–Keystoneç®¡ç†å‘˜å‡­è¯</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd ~
. admin-openrc
</code></pre></div></div>

<p>3ã€åˆ›å»ºNovaæœåŠ¡å‡­è¯</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€ åˆ›å»ºnovaç”¨æˆ·
openstack user create --domain default --password nova_pass nova

# 2ã€å°†ç®¡ç†å‘˜è§’è‰²æ·»åŠ éƒ½novaç”¨æˆ·å’Œserviceé¡¹ç›®ä¸­
openstack role add --project service --user nova admin

# 3ã€åˆ›å»ºnovaæœåŠ¡å®ä½“
openstack service create --name nova --description "OpenStack Compute" compute
</code></pre></div></div>

<p>4ã€åˆ›å»ºNovaæœåŠ¡APIç«¯ç‚¹</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack endpoint create --region RegionOne compute public http://controller:8774/v2.1
openstack endpoint create --region RegionOne compute internal http://controller:8774/v2.1
openstack endpoint create --region RegionOne compute admin http://controller:8774/v2.1
</code></pre></div></div>

<h3 id="72å®‰è£…åŠé…ç½®">7.2ã€å®‰è£…åŠé…ç½®</h3>
<p>1ã€å®‰è£…è½¯ä»¶åŒ…</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum install -y openstack-nova-api openstack-nova-conductor openstack-nova-novncproxy openstack-nova-scheduler
</code></pre></div></div>

<p>2ã€ç¼–è¾‘nova.confé…ç½®æ–‡ä»¶</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€å¤‡ä»½åŸæ–‡ä»¶
sed -i.default -e '/^#/d' -e '/^$/d' /etc/nova/nova.conf

# 2ã€ä¿®æ”¹æ¨¡å—å¦‚ä¸‹ï¼Œvim /etc/nova/nova.conf
[DEFAULT]
enabled_apis = osapi_compute,metadata
transport_url = rabbit://openstack:openstack@controller
my_ip = 192.168.172.179
use_neutron = true
firewall_driver = nova.virt.firewall.NoopFirewallDriver
rpc_backend=rabbit

[api]
auth_strategy = keystone

[api_database]
connection = mysql+pymysql://nova:NOVA_DBPASS@controller/nova_api

[database]
connection = mysql+pymysql://nova:NOVA_DBPASS@controller/nova

[glance]
api_servers = http://controller:9292

[keystone_authtoken]
auth_url = http://controller:5000/v3
memcached_servers = controller:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = nova
password = nova_pass

[placement]
region_name = RegionOne
project_domain_name = Default
project_name = service
auth_type = password
user_domain_name = Default
auth_url = http://controller:5000/v3
username = placement
password = placement_pass

[vnc]
enabled = true
server_listen = $my_ip
server_proxyclient_address = $my_ip
</code></pre></div></div>

<p>3ã€åŒæ­¥nova-apiæ•°æ®åº“</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>su -s /bin/sh -c "nova-manage api_db sync" nova
</code></pre></div></div>

<p>4ã€æ³¨å†Œcell0æ•°æ®åº“</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>su -s /bin/sh -c "nova-manage cell_v2 map_cell0" nova
</code></pre></div></div>

<p>5ã€åˆ›å»ºcell1åŸä»¶</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>su -s /bin/sh -c "nova-manage cell_v2 create_cell --name=cell1 --verbose" nova
</code></pre></div></div>

<p>6ã€åŒæ­¥novaæ•°æ®åº“</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>su -s /bin/sh -c "nova-manage db sync" nova
</code></pre></div></div>

<p>7ã€éªŒè¯novacell0å’Œcell1æ³¨å†Œæƒ…å†µ</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>su -s /bin/sh -c "nova-manage cell_v2 list_cells" nova
</code></pre></div></div>

<h3 id="73å¯åŠ¨å¹¶åŠ å…¥å¼€æœºè‡ªå¯">7.3ã€å¯åŠ¨å¹¶åŠ å…¥å¼€æœºè‡ªå¯</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl start openstack-nova-api.service openstack-nova-scheduler.service \
  openstack-nova-conductor.service openstack-nova-novncproxy.service

systemctl enable openstack-nova-api.service openstack-nova-scheduler.service \
  openstack-nova-conductor.service openstack-nova-novncproxy.service
</code></pre></div></div>

<h2 id="å…«å‡†å¤‡ä¸€å°è®¡ç®—èŠ‚ç‚¹è™šæ‹Ÿæœº">å…«ã€å‡†å¤‡ä¸€å°è®¡ç®—èŠ‚ç‚¹è™šæ‹Ÿæœº</h2>
<h3 id="81å®‰è£…åŸºç¡€æœåŠ¡">8.1ã€å®‰è£…åŸºç¡€æœåŠ¡</h3>
<p>1ã€å¯ç”¨OpenStackåº“</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum install -y centos-release-openstack-stein
</code></pre></div></div>
<p>2ã€å®‰è£… OpenStack å®¢æˆ·ç«¯</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum install -y python-openstackclient
</code></pre></div></div>
<p>3ã€æ—¶é—´åŒæ­¥</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€å®‰è£…è½¯ä»¶åŒ…
yum install -y chrony

# 2ã€å°†æ—¶é—´åŒæ­¥æœåŠ¡å™¨ä¿®æ”¹ä¸ºcontrollerèŠ‚ç‚¹
sed -i '/^server/d' /etc/chrony.conf
sed -i '2aserver controller iburst' /etc/chrony.conf

# 3ã€å¯åŠ¨ NTP æœåŠ¡å¹¶å°†å…¶é…ç½®ä¸ºéšç³»ç»Ÿå¯åŠ¨
systemctl enable chronyd.service
systemctl start chronyd.service

# 4ã€è®¾ç½®æ—¶åŒº
timedatectl set-timezone Asia/Shanghai

# 5ã€æŸ¥çœ‹æ—¶é—´åŒæ­¥æº
chronyc sources

# 6ã€æŸ¥çœ‹æ—¶é—´æ˜¯å¦æ­£ç¡®
timedatectl status
</code></pre></div></div>

<h2 id="ä¹è®¡ç®—èŠ‚ç‚¹å®‰è£…nova">ä¹ã€è®¡ç®—èŠ‚ç‚¹å®‰è£…Nova</h2>
<h3 id="91å®‰è£…åŠé…ç½®">9.1ã€å®‰è£…åŠé…ç½®</h3>
<p>1ã€å®‰è£…è½¯ä»¶åŒ…</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum install -y openstack-nova-compute
</code></pre></div></div>

<p>2ã€æ£€æŸ¥æ˜¯å¦æ”¯æŒè™šæ‹ŸåŒ–</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>egrep -c '(vmx|svm)' /proc/cpuinfo  # ç»“æœå¤§äºç­‰äº1,æ”¯æŒ
</code></pre></div></div>

<p>3ã€ç¼–è¾‘nova.confé…ç½®æ–‡ä»¶</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€å¤‡ä»½åŸæ–‡ä»¶
sed -i.default -e '/^#/d' -e '/^$/d' /etc/nova/nova.conf

# 2ã€ä¿®æ”¹æ¨¡å—å¦‚ä¸‹ï¼Œvim /etc/nova/nova.conf
[DEFAULT]
enabled_apis = osapi_compute,metadata
transport_url = rabbit://openstack:openstack@controller
my_ip = 192.168.172.180
use_neutron = true
firewall_driver = nova.virt.firewall.NoopFirewallDriver

[api]
auth_strategy = keystone

[keystone_authtoken]
auth_url = http://controller:5000/v3
memcached_servers = controller:11211
auth_type = password
project_domain_name = Default
user_domain_name = Default
project_name = service
username = nova
password = nova_pass

[vnc]
enabled = true
server_listen = 0.0.0.0
server_proxyclient_address = $my_ip
novncproxy_base_url = http://controller:6080/vnc_auto.html

[glance]
api_servers = http://controller:9292

[oslo_concurrency]
lock_path = /var/lib/nova/tmp

[libvirt]
virt_type = qemu
</code></pre></div></div>

<p>4ã€å¯åŠ¨å¹¶åŠ å…¥å¼€æœºè‡ªå¯</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl start libvirtd.service openstack-nova-compute.service
systemctl enable libvirtd.service openstack-nova-compute.service
</code></pre></div></div>

<h3 id="92åœ¨æ§åˆ¶èŠ‚ç‚¹ä¸Šæ·»åŠ è®¡ç®—èŠ‚ç‚¹">9.2ã€åœ¨æ§åˆ¶èŠ‚ç‚¹ä¸Šæ·»åŠ è®¡ç®—èŠ‚ç‚¹</h3>
<p>1ã€å–å¾—keystoneç®¡ç†å‘˜å‡­æ®</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd ~
. admin-openrc
</code></pre></div></div>

<p>2ã€æ·»åŠ è®¡ç®—èŠ‚ç‚¹åˆ°cell æ•°æ®åº“</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack compute service list --service nova-compute
</code></pre></div></div>

<p>3ã€å‘ç°è®¡ç®—èŠ‚ç‚¹</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># æ‰‹åŠ¨å‘ç°
su -s /bin/sh -c "nova-manage cell_v2 discover_hosts --verbose" nova

# å®šæœŸä¸»åŠ¨å‘ç°
# 1ã€ä¿®æ”¹/etc/nova/nova.confé…ç½®æ–‡ä»¶
[scheduler]
discover_hosts_in_cells_interval=300

# 2ã€é‡å¯novaæœåŠ¡
systemctl restart openstack-nova-api.service openstack-nova-scheduler.service \
  openstack-nova-conductor.service openstack-nova-novncproxy.service
</code></pre></div></div>

<h2 id="åæ§åˆ¶èŠ‚ç‚¹å®‰è£…neutron">åã€æ§åˆ¶èŠ‚ç‚¹å®‰è£…Neutron</h2>
<h3 id="101å®‰è£…å‰æ">10.1ã€å®‰è£…å‰æ</h3>
<p>1ã€å»ºåº“å¹¶æˆæƒ</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>create database neutron;
grant all privileges on neutron.* to 'neutron_user'@'controller' identified by 'neutron_pass';
flush privileges;
quit;
</code></pre></div></div>

<p>2ã€è·å–Keystoneç®¡ç†å‘˜å‡­è¯</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd ~
. admin-openrc
</code></pre></div></div>

<p>3ã€åˆ›å»ºNeutronæœåŠ¡å‡­è¯</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack user create --domain default --password neutron_pass neutron
openstack role add --project service --user neutron admin
openstack service create --name neutron --description "OpenStack Networking" network
</code></pre></div></div>

<p>4ã€åˆ›å»ºNeutronæœåŠ¡APIç«¯ç‚¹</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack endpoint create --region RegionOne network public http://controller:9696
openstack endpoint create --region RegionOne network internal http://controller:9696
openstack endpoint create --region RegionOne network admin http://controller:9696
</code></pre></div></div>

<h3 id="102å®‰è£…åŠé…ç½®">10.2ã€å®‰è£…åŠé…ç½®</h3>
<p>1ã€å®‰è£…è½¯ä»¶</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum install -y openstack-neutron openstack-neutron-ml2 \
  openstack-neutron-linuxbridge ebtables
</code></pre></div></div>

<p>2ã€ç¼–è¾‘neutron.confé…ç½®æ–‡ä»¶</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€å¤‡ä»½åŸæ–‡ä»¶å¹¶åˆ é™¤æ³¨é‡Š
sed -i.default -e '/^#/d' -e '/^$/d' /etc/neutron/neutron.conf

# 2ã€ä¿®æ”¹æ¨¡å—å¦‚ä¸‹ï¼Œvim /etc/neutron/neutron.conf
[DEFAULT]
core_plugin = ml2
service_plugins = router
allow_overlapping_ips = true
transport_url = rabbit://openstack:openstack@controller
auth_strategy = keystone
notify_nova_on_port_status_changes = true
notify_nova_on_port_data_changes = true

[database]
connection = mysql+pymysql://neutron_user:neutron_pass@controller/neutron

[keystone_authtoken]
www_authenticate_uri = http://controller:5000
auth_url = http://controller:5000
memcached_servers =controller:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = neutron
password = neutron_pass

[oslo_concurrency]
lock_path = /var/lib/neutron/tmp

[nova]
auth_url = http://controller:5000
auth_type = password
project_domain_name = default
user_domain_name = default
region_name = RegionOne
project_name = service
username = nova
password = nova_pass
</code></pre></div></div>

<p>3ã€é…ç½®æ¨¡å—åŒ–ç¬¬2å±‚ï¼ˆML2ï¼‰æ’ä»¶</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€å¤‡ä»½åŸæ–‡ä»¶å¹¶åˆ é™¤æ³¨é‡Š
sed -i.default -e '/^#/d' -e '/^$/d' /etc/neutron/plugins/ml2/ml2_conf.ini

# 2ã€ä¿®æ”¹æ¨¡å—å¦‚ä¸‹ï¼Œvim /etc/neutron/plugins/ml2/ml2_conf.ini
[ml2]
type_drivers = flat,vlan,vxlan
tenant_network_types = vxlan
mechanism_drivers = linuxbridge,l2population
extension_drivers = port_security

[ml2_type_flat]
flat_networks = provider

[ml2_type_vxlan]
vni_ranges = 1:1000

[securitygroup]
enable_ipset = true
</code></pre></div></div>

<p>4ã€é…ç½®Linuxæ¡¥ä»£ç†</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€å¤‡ä»½åŸæ–‡ä»¶å¹¶åˆ é™¤æ³¨é‡Š
sed -i.default -e '/^#/d' -e '/^$/d' /etc/neutron/plugins/ml2/linuxbridge_agent.ini

# 2ã€ä¿®æ”¹æ¨¡å—å¦‚ä¸‹ï¼Œvim /etc/neutron/plugins/ml2/linuxbridge_agent.ini
[linux_bridge]
physical_interface_mappings = provider:eth0

[vxlan]
enable_vxlan = false

[securitygroup]
enable_security_group = true
firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver
</code></pre></div></div>

<p>5ã€é…ç½®DHCPä»£ç†</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€å¤‡ä»½åŸæ–‡ä»¶å¹¶åˆ é™¤æ³¨é‡Š
sed -i.default -e '/^#/d' -e '/^$/d' /etc/neutron/dhcp_agent.ini

# 2ã€ä¿®æ”¹æ¨¡å—å¦‚ä¸‹ï¼Œvim /etc/neutron/dhcp_agent.ini
[DEFAULT]
interface_driver = linuxbridge
dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq
enable_isolated_metadata = true
</code></pre></div></div>

<p>6ã€é…ç½®å…ƒæ•°æ®ä»£ç†</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€å¤‡ä»½åŸæ–‡ä»¶å¹¶åˆ é™¤æ³¨é‡Š
sed -i.default -e '/^#/d' -e '/^$/d' /etc/neutron/metadata_agent.ini

# 2ã€ä¿®æ”¹æ¨¡å—å¦‚ä¸‹ï¼Œvim /etc/neutron/metadata_agent.ini
[DEFAULT]
nova_metadata_host = controller
metadata_proxy_shared_secret = metadata_secret
</code></pre></div></div>

<p>7ã€é…ç½®/etc/nova/nova.confæ–‡ä»¶neutronæ¨¡å—</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[neutron]
url = http://controller:9696
auth_url = http://controller:5000
auth_type = password
project_domain_name = default
user_domain_name = default
region_name = RegionOne
project_name = service
username = neutron
password = neutron_pass
service_metadata_proxy = true
metadata_proxy_shared_secret = metadata_secret
</code></pre></div></div>

<p>8ã€åˆ›å»ºç½‘ç»œæœåŠ¡åˆå§‹åŒ–è„šæœ¬éœ€è¦çš„è½¯è¿æ¥</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ln -s /etc/neutron/plugins/ml2/ml2_conf.ini /etc/neutron/plugin.ini
</code></pre></div></div>

<p>9ã€åŒæ­¥æ•°æ®åº“</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>su -s /bin/sh -c "neutron-db-manage --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head" neutron
</code></pre></div></div>

<p>10ã€é‡å¯Compute APIæœåŠ¡</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl restart openstack-nova-api.service
</code></pre></div></div>

<p>11ã€å¯åŠ¨ç½‘ç»œæœåŠ¡å¹¶å¼€å¯è‡ªå¯</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl start neutron-server.service \
  neutron-linuxbridge-agent.service \
  neutron-dhcp-agent.service \
  neutron-metadata-agent.service

systemctl enable neutron-server.service \
  neutron-linuxbridge-agent.service \
  neutron-dhcp-agent.service \
  neutron-metadata-agent.service
</code></pre></div></div>

<h2 id="åä¸€è®¡ç®—èŠ‚ç‚¹å®‰è£…neutron">åä¸€ã€è®¡ç®—èŠ‚ç‚¹å®‰è£…Neutron</h2>
<p>1ã€å®‰è£…è½¯ä»¶</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum install -y openstack-neutron-linuxbridge ebtables ipset
</code></pre></div></div>

<p>2ã€ç¼–è¾‘neutron.confé…ç½®æ–‡ä»¶</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€å¤‡ä»½åŸæ–‡ä»¶å¹¶åˆ é™¤æ³¨é‡Š
sed  -i.default-e '/^#/d' -e '/^$/d' /etc/neutron/neutron.conf

# 2ã€ä¿®æ”¹æ¨¡å—å¦‚ä¸‹ï¼Œvim /etc/neutron/neutron.conf
[DEFAULT]
transport_url = rabbit://openstack:openstack@controller
auth_strategy = keystone

[keystone_authtoken]
www_authenticate_uri = http://controller:5000
auth_url = http://controller:5000
memcached_servers =controller:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = neutron
password = neutron_pass

[oslo_concurrency]
lock_path = /var/lib/neutron/tmp
</code></pre></div></div>

<p>3ã€é…ç½®Linuxæ¡¥ä»£ç†</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€å¤‡ä»½åŸæ–‡ä»¶å¹¶åˆ é™¤æ³¨é‡Š
sed -i.bak -e '/^#/d' -e '/^$/d' /etc/neutron/plugins/ml2/linuxbridge_agent.ini

# 2ã€ä¿®æ”¹æ¨¡å—å¦‚ä¸‹ï¼Œvim /etc/neutron/plugins/ml2/linuxbridge_agent.ini
[linux_bridge]
physical_interface_mappings = provider:eth0

[vxlan]
enable_vxlan = false

[securitygroup]
enable_security_group = true
firewall_driver = neutron.agent.linux.iptables_firewall.IptablesFirewallDriver
</code></pre></div></div>

<p>4ã€ç¡®ä¿æ‚¨çš„Linuxæ“ä½œç³»ç»Ÿå†…æ ¸æ”¯æŒç½‘æ¡¥è¿‡æ»¤å™¨</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€æ·»åŠ é…ç½®
cat &gt;&gt;/etc/sysctl.conf&lt;&lt;EOF
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF

# 2ã€å¯ç”¨
modprobe br_netfilter

# 3ã€ç”Ÿæ•ˆ
 sysctl -p
</code></pre></div></div>

<p>5ã€ç¼–è¾‘/etc/nova/nova.confæ–‡ä»¶</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># 1ã€å¤‡ä»½åŸæ–‡ä»¶å¹¶åˆ é™¤æ³¨é‡Š
sed -i.default -e '/^#/d' -e '/^$/d'  /etc/nova/nova.conf

# 2ã€ä¿®æ”¹æ¨¡å—å¦‚ä¸‹ï¼Œvim /etc/nova/nova.conf
[neutron]
url = http://controller:9696
auth_url = http://controller:5000
auth_type = password
project_domain_name = default
user_domain_name = default
region_name = RegionOne
project_name = service
username = neutron
password = neutron_pass
</code></pre></div></div>

<p>6ã€é‡æ–°å¯åŠ¨Nova ComputeæœåŠ¡</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl restart openstack-nova-compute.service
</code></pre></div></div>

<p>7ã€å¯åŠ¨Linuxç½‘æ¡¥ä»£ç†å¹¶å¼€æœºè‡ªå¯åŠ¨</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl enable neutron-linuxbridge-agent.service
systemctl start neutron-linuxbridge-agent.service
</code></pre></div></div>

<p>8ã€éªŒè¯(åœ¨æ§åˆ¶èŠ‚ç‚¹ä¸Šæ“ä½œ)</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack extension list --network
openstack network agent list   # æ³¨æ„ï¼šä¸€å…±4ä¸ªï¼Œå…¶ä¸­ä¸¤ä¸ªæ˜¯Linux bridge agentè¯´æ˜æˆåŠŸ
+--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+
| ID                                   | Agent Type         | Host       | Availability Zone | Alive | State | Binary                    |
+--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+
| 14b7daf4-29bb-431f-bbf3-2688f095978b | Linux bridge agent | computer   | None              | :-)   | UP    | neutron-linuxbridge-agent |
| 174e4857-63bb-4222-bbab-06d948fdb23a | Metadata agent     | controller | None              | :-)   | UP    | neutron-metadata-agent    |
| 98c56b29-8c37-4181-b26e-af9333316be3 | Linux bridge agent | controller | None              | :-)   | UP    | neutron-linuxbridge-agent |
| eb049ecb-75d0-40d3-98d8-694d19a3aaaf | DHCP agent         | controller | nova              | :-)   | UP    | neutron-dhcp-agent        |
+--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+
</code></pre></div></div>

<h2 id="åäºŒåˆ›å»ºä¸€å°è™šæ‹Ÿæœºæ§åˆ¶èŠ‚ç‚¹">åäºŒã€åˆ›å»ºä¸€å°è™šæ‹Ÿæœºï¼ˆæ§åˆ¶èŠ‚ç‚¹ï¼‰</h2>
<blockquote>
  <p>æ³¨æ„ï¼š ä»¥ä¸‹æ­¥éª¤å‡åœ¨æ§åˆ¶èŠ‚ç‚¹ä¸Šæ“ä½œ</p>
</blockquote>

<h3 id="121åˆ›å»ºç½‘ç»œ">12.1ã€åˆ›å»ºç½‘ç»œ</h3>
<p>1ã€è·å–keystoneç®¡ç†å‘˜å‡­è¯</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd ~
. admin-openrc
</code></pre></div></div>

<p>2ã€åˆ›å»ºç½‘ç»œ</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack network create  --share --external \
  --provider-physical-network provider \
  --provider-network-type flat provider

openstack network list  # æŸ¥çœ‹
</code></pre></div></div>

<p>3ã€åˆ›å»ºå­ç½‘</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack subnet create --network provider \
  --allocation-pool start=192.168.172.220,end=192.168.172.230 \
  --dns-nameserver 8.8.8.8 --gateway 192.168.172.1 \
  --subnet-range 192.168.172.0/24 provider-sub

openstack subnet list
</code></pre></div></div>

<h3 id="122åˆ›å»ºä¸»æœºè§„æ ¼">12.2ã€åˆ›å»ºä¸»æœºè§„æ ¼</h3>
<p>1ã€è·å–keystoneç®¡ç†å‘˜å‡­è¯</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd ~
. admin-openrc
</code></pre></div></div>
<p>2ã€åˆ›å»ºä¸»æœºè§„æ ¼</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack flavor create --id 0 --vcpus 1 --ram 64 --disk 1 m1.nano
# openstack flavor create åˆ›å»ºä¸»æœº
# --id ä¸»æœºID
# --vcpus cpuæ•°é‡
# --ram 64ï¼ˆé»˜è®¤æ˜¯MBï¼Œå¯ä»¥å†™æˆGï¼‰
# --disk ç£ç›˜ï¼ˆé»˜è®¤å•ä½æ˜¯Gï¼‰
</code></pre></div></div>

<h3 id="123åˆ›å»ºä¸€ä¸ªå®ä¾‹">12.3ã€åˆ›å»ºä¸€ä¸ªå®ä¾‹</h3>
<p>1ã€è·å–demoç”¨æˆ·æƒé™å‡­è¯</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd ~
. demo-openrc
</code></pre></div></div>
<p>2ã€ç”Ÿæˆç§˜é’¥å¯¹</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-keygen -q -N ""
</code></pre></div></div>
<p>3ã€å°†å¯†é’¥æ”¾åœ¨openstackä¸Š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack keypair create --public-key ~/.ssh/id_rsa.pub mykey
</code></pre></div></div>
<p>4ã€éªŒè¯å¯†ç æ˜¯å¦åˆ›å»ºæˆåŠŸ</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nova keypair-list
</code></pre></div></div>
<p>5ã€æ·»åŠ å®‰å…¨ç»„è§„åˆ™</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># å…è®¸ICMPï¼ˆping
openstack security group rule create --proto icmp default

# å…è®¸å®‰å…¨shellï¼ˆSSHï¼‰è®¿é—®
openstack security group rule create --proto tcp --dst-port 22 default
</code></pre></div></div>
<p>6ã€æŸ¥çœ‹åˆ›å»ºå®ä¾‹éœ€è¦çš„ç›¸å…³ä¿¡æ¯</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack flavor list
openstack image list
openstack network list
openstack security group list
openstack keypair list
</code></pre></div></div>
<p>7ã€åˆ›å»ºå¹¶å¯åŠ¨å®ä¾‹</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack server create --flavor m1.nano --image cirros \
  --nic net-id=9e07c3d5-9a9e-496c-90b6-ba294f8b0699  \
  --security-group default \
  --key-name mykey hello-instance


# â€“flavor: ç±»å‹åç§°
# â€“image: é•œåƒåç§°
# --nicï¼š æŒ‡å®šç½‘ç»œIDï¼Œæ ¹æ®åˆšåˆšopenstack network listæŸ¥åˆ°çš„ç½‘ç»œIDå¡«å†™,ä¸æ˜¯å­ç½‘å“¦
# â€“security-groupï¼šå®‰å…¨ç»„å

</code></pre></div></div>
<p>8ã€æŸ¥çœ‹å®ä¾‹çŠ¶æ€</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@controller ~]# openstack server list
+--------------------------------------+----------------+--------+---------------------+--------+---------+
| ID                                   | Name           | Status | Networks            | Image  | Flavor  |
+--------------------------------------+----------------+--------+---------------------+--------+---------+
| 0d94ce6d-ae08-4ace-a183-3ecd44ccba56 | hello-instance | ACTIVE | provider=10.0.0.138 | cirros | m1.nano |
+--------------------------------------+----------------+--------+---------------------+--------+---------+
</code></pre></div></div>

<h2 id="124-ç™»å½•å®ä¾‹">12.4 ç™»å½•å®ä¾‹</h2>
<h3 id="1241é€šè¿‡sshç™»å½•">12.4.1ã€é€šè¿‡SSHç™»å½•</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ping 10.0.0.138

ssh cirros@10.0.0.138
</code></pre></div></div>

<h2 id="åä¸‰cinderå®‰è£…">åä¸‰ã€Cinderå®‰è£…</h2>
<h3 id="131åˆ›å»ºæ•°æ®åº“">13.1ã€åˆ›å»ºæ•°æ®åº“</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ CREATE DATABASE cinder;
$ GRANT ALL PRIVILEGES ON cinder.* TO â€˜cinderâ€™@â€˜localhostâ€™
IDENTIFIED BY â€˜123123â€™;
$ GRANT ALL PRIVILEGES ON cinder.* TO â€˜cinderâ€™@â€™%â€™
IDENTIFIED BY â€˜123123â€™;
$ exit
</code></pre></div></div>

<h3 id="132åˆ›å»ºcinderç”¨æˆ·">13.2ã€åˆ›å»ºcinderç”¨æˆ·</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ source /root/admin-openrc
$ openstack user create --domain default --password-prompt cinder
</code></pre></div></div>

<h3 id="133å°†adminè§’è‰²æ·»åŠ åˆ°cinderç”¨æˆ·">13.3ã€å°†adminè§’è‰²æ·»åŠ åˆ°cinderç”¨æˆ·</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack role add --project service --user cinder admin
</code></pre></div></div>

<h3 id="134åˆ›å»ºcinderv2å’Œcinderv3æœåŠ¡å®ä½“">13.4ã€åˆ›å»ºcinderv2å’Œcinderv3æœåŠ¡å®ä½“</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ openstack service create --name cinderv2  --description "OpenStack Block Storage" volumev2
$ openstack service create --name cinderv3  --description "OpenStack Block Storage" volumev3
</code></pre></div></div>
<h3 id="135åˆ›å»ºblock-storageæœåŠ¡apiç«¯ç‚¹">13.5ã€åˆ›å»ºBlock StorageæœåŠ¡APIç«¯ç‚¹</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ openstack endpoint create --region RegionOne  volumev2 public http://controller:8776/v2/%\(project_id\)s
$ openstack endpoint create --region RegionOne  volumev2 internal http://controller:8776/v2/%\(project_id\)s
$ openstack endpoint create --region RegionOne  volumev2 admin http://controller:8776/v2/%\(project_id\)s
$ openstack endpoint create --region RegionOne  volumev3 public http://controller:8776/v3/%\(project_id\)s
$ openstack endpoint create --region RegionOne  volumev3 internal http://controller:8776/v3/%\(project_id\)s
$ openstack endpoint create --region RegionOne  volumev3 admin http://controller:8776/v3/%\(project_id\)s
</code></pre></div></div>

<h3 id="136å®‰è£…cinderè½¯ä»¶åŒ…">13.6ã€å®‰è£…Cinderè½¯ä»¶åŒ…</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ yum install openstack-cinder -y
</code></pre></div></div>

<h3 id="137é…ç½®">13.7ã€é…ç½®</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cp /etc/cinder/cinder.conf /etc/cinder/cinder.conf.bak
$ vi /etc/cinder/cinder.conf
[DEFAULT]
transport_url = rabbit://openstack:openstack@controller
auth_strategy = keystone
my_ip = 192.168.172.179

[database]
connection = mysql+pymysql://cinder:123123@controller/cinder

[keystone_authtoken]
www_authenticate_uri = http://controller:5000
auth_url = http://controller:5000
memcached_servers = controller:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = cinder
password = 123123

[oslo_concurrency]
lock_path = /var/lib/cinder/tmp
</code></pre></div></div>
<p>2ã€ä¿®æ”¹cinderé…ç½®</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ vi /etc/nova/nova.conf
[cinder]
os_region_name = RegionOne
</code></pre></div></div>

<h3 id="138åˆå§‹åŒ–æ•°æ®">13.8ã€åˆå§‹åŒ–æ•°æ®</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ su -s /bin/sh -c "cinder-manage db sync" cinder
</code></pre></div></div>

<h3 id="139å¯åŠ¨æœåŠ¡">13.9ã€å¯åŠ¨æœåŠ¡</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ systemctl restart openstack-nova-api.service
$ systemctl enable openstack-cinder-api.service openstack-cinder-scheduler.service
$ systemctl start openstack-cinder-api.service openstack-cinder-scheduler.service
</code></pre></div></div>

<h3 id="14dashboardæƒ³è¦æ˜¾ç¤ºçš„èŠ±é‡å¯ä¸‹httpd">14ã€dashboardæƒ³è¦æ˜¾ç¤ºçš„èŠ±é‡å¯ä¸‹httpd</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ systemctl restart httpd
</code></pre></div></div>

<h2 id="åå››openstackå¯¹æ¥ceph">åå››ã€openstackå¯¹æ¥ceph</h2>
<h3 id="141-openstackå¯¹æ¥cephæœ‰3å¤§æ¨¡å—å¯ä»¥ä½¿ç”¨ceph">14.1 Openstackå¯¹æ¥Cephï¼Œæœ‰3å¤§æ¨¡å—å¯ä»¥ä½¿ç”¨Ceph</h3>

<p><strong>é•œåƒ</strong></p>
<ul>
  <li>Openstackçš„Glanceç»„ä»¶æä¾›é•œåƒæœåŠ¡ï¼Œå¯ä»¥å°†Imageç›´æ¥å­˜å‚¨åœ¨Cephä¸­ã€‚</li>
</ul>

<p><strong>æ“ä½œç³»ç»Ÿç›˜</strong></p>
<ul>
  <li>Openstackçš„Novaç»„ä»¶æä¾›è®¡ç®—æœåŠ¡ï¼Œä¸€ä¸ªè™šæœºçš„åˆ›å»ºå¿…ç„¶éœ€è¦æ“ä½œç³»ç»Ÿï¼Œä¹Ÿå°±å°‘ä¸äº†ç³»ç»Ÿç›˜ï¼Œç³»ç»Ÿç›˜å¯ä»¥ä½¿ç”¨Cephæ¥æä¾›ã€‚</li>
</ul>

<p><strong>éæ“ä½œç³»ç»Ÿç›˜</strong></p>
<ul>
  <li>Openstackçš„Cinderç»„ä»¶æä¾›å—å­˜å‚¨æœåŠ¡ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç‰©ç†æœºä¸­çš„æ™®é€šç£ç›˜ï¼Œä¹Ÿå¯ä»¥é€šè¿‡Cephæ¥æä¾›ã€‚</li>
</ul>

<p>ä»¥ä¸Š3ä¸ªç»„ä»¶ä»Openstackè§’åº¦æ¥è¯´ï¼Œæ˜¯ä¸åŒçš„3ä¸ªæ¨¡å—ï¼Œæä¾›çš„æœåŠ¡ä¹Ÿä¸åŒï¼Œä½†å¯¹äºCephæ¥è¯´ï¼Œéƒ½æ˜¯ä¸€ä¸ªRbd Imageï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå—å­˜å‚¨ã€‚
èµ°çš„æ˜¯åŒæ ·çš„APIï¼Œä½†æ˜¯åœ¨ä¸€äº›å±æ€§å’Œå‚æ•°é—´å­˜åœ¨ä¸€äº›å·®å¼‚ã€‚
å…·ä½“æ“ä½œ
åˆ›å»ºå­˜å‚¨æ± 
é’ˆå¯¹Openstackçš„3ä¸ªä¸åŒæœåŠ¡ï¼Œéœ€è¦æŠŠå­˜å‚¨èµ„æºæ± éš”ç¦»å¼€ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªæœåŠ¡ä¸€ä¸ªPoolï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1ã€åˆ›å»ºvolumesæ± ï¼Œå¯¹åº”CinderæœåŠ¡
$ ceph osd pool create volumes 128

2ã€åˆ›å»ºimagesæ± ï¼Œå¯¹åº”GlanceæœåŠ¡
$ ceph osd pool create images 128

3ã€åˆ›å»ºvmsæ± ï¼Œå¯¹åº”NovaæœåŠ¡
$ ceph osd pool create vms 128

4ã€åˆ›å»ºbackupsæ± ï¼Œå¯¹åº”Cinder-backupæœåŠ¡ã€‚ä½†è¿™ä¸ªbackupåœ¨åŒä¸€Cephé›†ç¾¤ä¸­ï¼Œæ„ä¹‰ä¸å¤§ï¼Œæ—¢ç„¶æ˜¯åšå¤‡ä»½çš„è¯ï¼Œå°±åº”è¯¥è·¨é›†ç¾¤æˆ–è€…è·¨æœºæˆ¿ã€è·¨åŒºåŸŸæ¥è¾¾åˆ°å¤‡ä»½å®¹ç¾çš„ç›®çš„ã€‚ï¼ˆè¿™é‡Œæ²¡æœ‰ä½¿ç”¨ï¼‰
$ ceph osd pool create backups 128
</code></pre></div></div>

<h3 id="142-å®‰è£…cephç›¸å…³åŒ…">14.2 å®‰è£…Cephç›¸å…³åŒ…</h3>
<p>1ã€åœ¨glance-apiçš„ä¸»æœºä¸Šå®‰è£…python-rbdåŒ…</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ yum install python-rbd
</code></pre></div></div>

<p>2ã€åœ¨nova-computeã€cinder-volumeã€cinder-backupèŠ‚ç‚¹ä¸Šå®‰è£…ceph-commonåŒ…</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ yum install ceph-common
</code></pre></div></div>
<p>å®‰è£…å®ŒcephåŒ…ä¹‹åï¼Œéœ€è¦å°†cephé›†ç¾¤çš„ceph.conf copyåˆ°æ‰€æœ‰clientç«¯ã€‚</p>

<blockquote>
  <p>å¦‚æœåœ¨Cephçš„é…ç½®ä¸­æ‰“å¼€äº†authè®¤è¯ï¼Œå°±éœ€è¦åšå¦‚ä¸‹çš„æ“ä½œï¼›å¦‚æœCephä¸­çš„authéƒ½æ˜¯è®¾ç½®çš„noneï¼Œä¹Ÿå°±æ˜¯å…³é—­çš„è¯ï¼Œå¯ä»¥ä¸åšå¦‚ä¸‹æ“ä½œã€‚</p>
</blockquote>

<p>3ã€åœ¨cephä¸­åˆ›å»ºäº†cinderã€glanceç­‰ç”¨æˆ·ï¼Œå¹¶åšäº†æƒé™æ§åˆ¶</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ceph auth get-or-create client.cinder mon 'allow r' osd 'allow class-read object_prefix rbd_children, allow rwx pool=volumes, allow rwx pool=vms, allow rx pool=images'
$ ceph auth get-or-create client.glance mon 'allow r' osd 'allow class-read object_prefix rbd_children, allow rwx pool=images'
$ ceph auth get-or-create client.cinder-backup mon 'allow r' osd 'allow class-read object_prefix rbd_children, allow rwx pool=backups'
</code></pre></div></div>
<p>å°†ä¸Šé¢ç”Ÿæˆçš„keyringæ–‡ä»¶ï¼Œä¿å­˜åœ¨ç›¸åº”çš„èŠ‚ç‚¹ä¸Šï¼Œå¹¶ä¿®æ”¹ä¸ºç›¸åº”çš„æƒé™</p>

<p>4ã€æŠŠcephèŠ‚ç‚¹*.keyringæ–‡ä»¶cpåˆ°controllerèŠ‚ç‚¹å’ŒcomputerèŠ‚ç‚¹</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ceph auth get-or-create client.glance | ssh controller sudo tee /etc/ceph/ceph.client.glance.keyring
ssh controller  sudo chown glance:glance /etc/ceph/ceph.client.glance.keyring

$ ceph auth get-or-create client.cinder | ssh controller  sudo tee /etc/ceph/ceph.client.cinder.keyring
ssh controller  sudo chown cinder:cinder /etc/ceph/ceph.client.cinder.keyring

$ ceph auth get-or-create client.cinder-backup | ssh controller  sudo tee /etc/ceph/ceph.client.cinder-backup.keyring
ssh controller  sudo chown cinder:cinder /etc/ceph/ceph.client.cinder-backup.keyring

$ ceph auth get-or-create client.cinder | ssh controller sudo tee /etc/ceph/ceph.client.cinder.keyring

$ ceph$: scp /etc/ceph/* root@{controller,computer}:/etc/ceph
</code></pre></div></div>

<p>5ã€åœ¨libvirtä¸Šæ·»åŠ secret key(<code class="highlighter-rouge">computer</code>èŠ‚ç‚¹)</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1.è·å–cinder keyringï¼Œå¹¶ä¿å­˜åˆ°ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ä¸­
$ ceph auth get-key client.cinder | ssh controller tee /etc/ceph/client.cinder.key

2.ç”Ÿæˆä¸€ä¸ªUUID
$ cd /etc/ceph
$ uuidgen
c4cd561d-5c25-44a4-8a9f-8b59659f1d1f

3.ä¿®æ”¹secret.xmlæ–‡ä»¶ï¼Œæ³¨æ„æ›¿æ¢ä¸‹é¢çš„uuid
$ cd /etc/ceph
$ cat &gt; secret.xml &lt;&lt;EOF
&lt;secret ephemeral='no' private='no'&gt;
  &lt;uuid&gt;c4cd561d-5c25-44a4-8a9f-8b59659f1d1f&lt;/uuid&gt;
  &lt;usage type='ceph'&gt;
    &lt;name&gt;client.cinder secret&lt;/name&gt;
  &lt;/usage&gt;
&lt;/secret&gt;
EOF

$ virsh secret-define --file secret.xml
Secret c4cd561d-5c25-44a4-8a9f-8b59659f1d1f created

5.è®¾ç½®libvirtçš„secret keyï¼Œå¹¶åˆ é™¤ä¹‹å‰çš„keyä¸´æ—¶æ–‡ä»¶
$ sudo virsh secret-set-value --secret c4cd561d-5c25-44a4-8a9f-8b59659f1d1f --base64 $(cat client.cinder.key) &amp;&amp; rm client.cinder.key secret.xml

6.å°†ç”Ÿæˆé…ç½®cpåˆ°controllerèŠ‚ç‚¹
$ scp /etc/ceph/* root@controller:/etc/ceph
</code></pre></div></div>

<h2 id="143-åœ¨novaglancecinderæ¨¡å—ä¸­é›†æˆcephç›¸å…³é…ç½®">14.3 åœ¨novaã€glanceã€cinderæ¨¡å—ä¸­é›†æˆcephç›¸å…³é…ç½®</h2>
<h3 id="glanceé…ç½®">Glanceé…ç½®</h3>
<p>1ã€åœ¨/etc/glance/glance-api.confä¸­æ·»åŠ å¦‚ä¸‹ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// åœ¨glance_storeåŸŸä¸­å¢åŠ å¦‚ä¸‹ï¼Œå¦‚æœæ²¡æœ‰glance_storeåŸŸï¼Œç›´æ¥åˆ›å»ºï¼š
[glance_store]
stores = rbd
default_store = rbd
rbd_store_pool = images
rbd_store_user = glance
rbd_store_ceph_conf = /etc/ceph/ceph.conf
rbd_store_chunk_size = 8
</code></pre></div></div>

<p>2ã€åœ¨æ§åˆ¶èŠ‚ç‚¹ï¼ˆcontrollerï¼‰é‡å¯glance-apiæœåŠ¡ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ systemctl restart openstack-glance-api.service
</code></pre></div></div>

<h3 id="cinderé…ç½®">Cinderé…ç½®</h3>
<p>1ã€åœ¨/etc/cinder/cinder.confä¸­æ·»åŠ å¦‚ä¸‹ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// åœ¨DEFAULTåŸŸä¸­å¢åŠ ï¼š
[DEFAULT]
enabled_backends = ceph

// åœ¨cephåŸŸä¸­å¢åŠ å¦‚ä¸‹ï¼Œå¦‚æœæ²¡æœ‰cephåŸŸï¼Œç›´æ¥åˆ›å»ºï¼š
[ceph]
volume_driver = cinder.volume.drivers.rbd.RBDDriver
volume_backend_name = ceph
rbd_pool = volumes
rbd_ceph_conf = /etc/ceph/ceph.conf
rbd_flatten_volume_from_snapshot = false
rbd_max_clone_depth = 5
rbd_store_chunk_size = 4
rados_connect_timeout = -1
glance_api_version = 2
rbd_user = cinder
rbd_secret_uuid = c4cd561d-5c25-44a4-8a9f-8b59659f1d1f
</code></pre></div></div>

<p>2ã€åœ¨CinderèŠ‚ç‚¹ï¼ˆcontrollerï¼‰ä¸Šï¼Œé‡å¯cinder-volumeæœåŠ¡.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ systemctl restart openstack-cinder-volume.service
</code></pre></div></div>

<h3 id="novaé…ç½®computerèŠ‚ç‚¹">Novaé…ç½®(computerèŠ‚ç‚¹)</h3>
<p>3ã€åœ¨Novaè®¡ç®—èŠ‚ç‚¹ï¼ˆcomputeï¼‰ä¸Šï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶/etc/nova/nova.conf</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[libvirt]
virt_type = qemu
inject_password=True
images_type = rbd
images_rbd_pool = vms
images_rbd_ceph_conf = /etc/ceph/ceph.conf
rbd_user = cinder
rbd_secret_uuid = c4cd561d-5c25-44a4-8a9f-8b59659f1d1f
disk_cachemodes="network=writeback"
è¯´æ˜ï¼šæ­¤å¤„uuidä¸º4.4-é…ç½®Cinderé›†æˆCephä¸­/etc/cinder/cinder.confçš„uuidã€‚
</code></pre></div></div>
<p>4ã€åœ¨Novaè®¡ç®—èŠ‚ç‚¹ï¼ˆcomputeï¼‰ä¸Šï¼Œé‡å¯nova-computeæœåŠ¡ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ systemctl restart openstack-nova-compute.service
</code></pre></div></div>

<h2 id="åäº”openstacké›†æˆcephéªŒè¯">åäº”ã€openstacké›†æˆcephéªŒè¯</h2>
<h3 id="151éªŒè¯glanceé›†æˆceph">15.1ã€éªŒè¯glanceé›†æˆceph</h3>
<p>1ã€åœ¨controllerèŠ‚ç‚¹æ‰§è¡Œï¼Œåˆ›å»ºæ–°çš„é•œåƒ CentOS6</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ openstack image create "CentOS6-ceph" --file centos-6.5-cloud.qcow2 --disk-format qcow2 --container-format bare --public
</code></pre></div></div>
<blockquote>
  <p>æ‰§è¡Œé•œåƒä¸Šä¼ ï¼ŒOpenStackæœ¬åœ°ç¯å¢ƒä¸­éœ€è¦æœ‰.qcow2æ ¼å¼çš„é•œåƒæ–‡ä»¶ï¼Œä¾‹å¦‚æœ¬ä¾‹ä¸­çš„ CentOS-7-aarch64-Custom.qcow2 é•œåƒ</p>
</blockquote>

<p>2ã€åœ¨controllerèŠ‚ç‚¹æŸ¥çœ‹OpenStackä¸­çš„å¯ç”¨é•œåƒï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ openstack image list
+--------------------------------------+---------------+--------+
| ID                                   | Name          | Status |
+--------------------------------------+---------------+--------+
| ebfa0cf8-8fdd-43bd-9c42-740852013784 | åˆå§‹åŒ–ç¯å¢ƒ    | active |
| 18e3d6ec-4d75-4f20-8955-9d1f2365cb64 | CentOS-ceph   | active |
| 1597d670-043a-48ad-afc6-06ebf5a3f863 | CentOS6-ceph  | active |
| fcf0e3ca-8094-4727-acb4-23506720e279 | CentOS7-image | active |
| 64f97270-ac02-48e8-b1f6-3bf635320c01 | centos6.5     | active |
| a2875426-9356-477f-9411-88e8a0a9c1f5 | cirros        | active |
+--------------------------------------+---------------+--------+
</code></pre></div></div>
<p>3ã€æŸ¥çœ‹ceph imageså­˜å‚¨æ± ä¸­çš„é•œåƒï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ rbd ls images
18e3d6ec-4d75-4f20-8955-9d1f2365cb64
</code></pre></div></div>

<h3 id="152éªŒè¯cinderé›†æˆceph">15.2éªŒè¯Cinderé›†æˆCeph</h3>
<p>1ã€åœ¨controllerèŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„OpenStack å·ceph_volumeï¼Œå¤§å°ä¸º10Gï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cinder create --name ceph_volume 10
</code></pre></div></div>

<p>2ã€åœ¨controllerèŠ‚ç‚¹æŸ¥çœ‹OpenStackä»¥åŠceph volumeså­˜å‚¨æ± ï¼Œå‘ç°å·åˆ›å»ºæˆåŠŸå¹¶å­˜å‚¨åœ¨cephä¸­ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@controller ~ ]# openstack volume list
+--------------------------------------+-------------+-----------+------+-------------+
| ID                                   | Name        | Status    | Size | Attached to |
+--------------------------------------+-------------+-----------+------+-------------+
| 9f334a48-6f47-40b0-8231-922a694c76cc | ceph_volume | available |   10 |             |
+--------------------------------------+-------------+-----------+------+-------------+

cephèŠ‚ç‚¹æ‰§è¡Œ
$ rbd ls volumes
volume-9f334a48-6f47-40b0-8231-922a694c76cc
</code></pre></div></div>

<h3 id="153éªŒè¯novaé›†æˆceph">15.3ã€éªŒè¯Novaé›†æˆCeph</h3>
<p>1ã€åœ¨controllerèŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œåˆ—å‡ºç¯å¢ƒä¸­å¯ç”¨çš„flavorä»¥åŠimageèµ„æº</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ openstack flavor list
+--------------------------------------+---------+------+------+-----------+-------+-----------+
| ID                                   | Name    |  RAM | Disk | Ephemeral | VCPUs | Is Public |
+--------------------------------------+---------+------+------+-----------+-------+-----------+
| 0                                    | m1.nano |   64 |   10 |         0 |     1 | True      |
| ea80193f-3f79-4a51-a8e7-ab17f1fa5cf8 | centos7 | 4096 |   50 |        10 |     4 | True      |
+--------------------------------------+---------+------+------+-----------+-------+-----------+

$ openstack image list
+--------------------------------------+---------------+--------+
| ID                                   | Name          | Status |
+--------------------------------------+---------------+--------+
| ebfa0cf8-8fdd-43bd-9c42-740852013784 | åˆå§‹åŒ–ç¯å¢ƒ    | active |
| 18e3d6ec-4d75-4f20-8955-9d1f2365cb64 | CentOS-ceph   | active |
| 1597d670-043a-48ad-afc6-06ebf5a3f863 | CentOS6-ceph  | active |
| fcf0e3ca-8094-4727-acb4-23506720e279 | CentOS7-image | active |
| 64f97270-ac02-48e8-b1f6-3bf635320c01 | centos6.5     | active |
| a2875426-9356-477f-9411-88e8a0a9c1f5 | cirros        | active |
+--------------------------------------+---------------+--------+
</code></pre></div></div>

<p>2ã€åœ¨controllerèŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œä½¿ç”¨ç°æœ‰èµ„æºåˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæœºï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ openstack server create --image 64f97270-ac02-48e8-b1f6-3bf635320c01 --flavor centos7 ceph-test
+-------------------------------------+--------------------------------------------------+
| Field                               | Value                                            |
+-------------------------------------+--------------------------------------------------+
| OS-DCF:diskConfig                   | MANUAL                                           |
| OS-EXT-AZ:availability_zone         |                                                  |
| OS-EXT-SRV-ATTR:host                | None                                             |
| OS-EXT-SRV-ATTR:hypervisor_hostname | None                                             |
| OS-EXT-SRV-ATTR:instance_name       |                                                  |
| OS-EXT-STS:power_state              | NOSTATE                                          |
| OS-EXT-STS:task_state               | scheduling                                       |
| OS-EXT-STS:vm_state                 | building                                         |
| OS-SRV-USG:launched_at              | None                                             |
| OS-SRV-USG:terminated_at            | None                                             |
| accessIPv4                          |                                                  |
| accessIPv6                          |                                                  |
| addresses                           |                                                  |
| adminPass                           | rp4NX8J3hFke                                     |
| config_drive                        |                                                  |
| created                             | 2020-05-13T06:26:34Z                             |
| flavor                              | centos7 (ea80193f-3f79-4a51-a8e7-ab17f1fa5cf8)   |
| hostId                              |                                                  |
| id                                  | f4a61a04-37ed-4dad-bb32-5e00da1b40b9             |
| image                               | centos6.5 (64f97270-ac02-48e8-b1f6-3bf635320c01) |
| key_name                            | None                                             |
| name                                | ceph-test                                        |
| progress                            | 0                                                |
| project_id                          | 6c95ba186f1047e0a632c3cd1ab08168                 |
| properties                          |                                                  |
| security_groups                     | name='default'                                   |
| status                              | BUILD                                            |
| updated                             | 2020-05-13T06:26:34Z                             |
| user_id                             | f04d7001c5b64c4dac71135043dbff09                 |
| volumes_attached                    |                                                  |
+-------------------------------------+--------------------------------------------------+
</code></pre></div></div>

<p>3ã€åœ¨controllerèŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œä¸€æ®µæ—¶é—´è¿‡åï¼ŒæŸ¥çœ‹è™šæ‹ŸçŠ¶æ€ï¼Œå¯ä»¥çœ‹åˆ°åˆ›å»ºå®Œæˆï¼Œåœ¨OpenStackç¯å¢ƒå’ŒcephæŸ¥çœ‹è™šæ‹Ÿæœºæ˜¯å¦å­˜åœ¨ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ openstack server list
+--------------------------------------+-----------+--------+----------+-----------+---------+
| ID                                   | Name      | Status | Networks | Image     | Flavor  |
+--------------------------------------+-----------+--------+----------+-----------+---------+
| f4a61a04-37ed-4dad-bb32-5e00da1b40b9 | ceph-test | ACTIVE |          | centos6.5 | centos7 |
+--------------------------------------+-----------+--------+----------+-----------+---------+

cephèŠ‚ç‚¹æ‰§è¡Œ
$ rbd ls vms
f4a61a04-37ed-4dad-bb32-5e00da1b40b9_disk
f4a61a04-37ed-4dad-bb32-5e00da1b40b9_disk.eph0
f4a61a04-37ed-4dad-bb32-5e00da1b40b9_disk.swap
</code></pre></div></div>

<h2 id="é‡åˆ°é—®é¢˜">é‡åˆ°é—®é¢˜ï¼š</h2>

<p>1ã€åˆ›å»ºå®ä¾‹å¤±è´¥ã€‚ERROR
<img src="D:/æœ‰é“äº‘å­˜å‚¨/qqF92BCC0821E4E2EABBA59CC968555837/mdimage/openstackå®ä¾‹åˆ›å»ºå¤±è´¥.png" alt="Openstackå®ä¾‹åˆ›å»ºå¤±è´¥" /></p>

<p>åå°nova computeræŠ¥é”™æ—¥å¿—
<img src="D:/æœ‰é“äº‘å­˜å‚¨/qqF92BCC0821E4E2EABBA59CC968555837/mdimage/openstackåˆ›å»ºå®ä¾‹å¤±è´¥1.png" alt="Openstackåˆ›å»ºå®ä¾‹å¤±è´¥" /></p>

<h4 id="è§£å†³æ–¹æ³•">è§£å†³æ–¹æ³•</h4>
<p><img src="D:/æœ‰é“äº‘å­˜å‚¨/qqF92BCC0821E4E2EABBA59CC968555837/mdimage/openstackæŠ¥é”™3.png" alt="Openstackåˆ›å»ºå®ä¾‹å¤±è´¥" /></p>

<p>åœ¨computeèŠ‚ç‚¹çš„<code class="highlighter-rouge">/etc/nova/nova.conf</code>ä¸­é…ç½®è¿æ¥placementè®¤è¯</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[placement]
region_name = RegionOne
project_domain_name = Default
project_name = service
auth_type = password
user_domain_name = Default
auth_url = http://controller:5000/v3
username = placement
password = placement_pass
</code></pre></div></div>
<blockquote>
  <p>placementåœ¨Sç‰ˆæœ¬å·²ç»å•ç‹¬æå‡ºæ¥åšè®¡ç®—èµ„æºçš„ç®¡ç†ã€‚å•ç‹¬ç»„ä»¶äº†</p>
</blockquote>

<h3 id="12åœ¨keystoneä¸­æ— æ³•æ‰¾åˆ°é»˜è®¤è§’è‰²user">1.2ã€åœ¨keystoneä¸­æ— æ³•æ‰¾åˆ°é»˜è®¤è§’è‰²â€userâ€</h3>
<p>é—®é¢˜æè¿°ï¼š<br />
åœ¨dashboardåˆ›å»ºé¡¹ç›®çš„æ—¶å€™å‡ºç°æ­¤æŠ¥é”™ã€‚</p>

<p>è§£å†³æ–¹æ³•:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>openstack role create user
</code></pre></div></div>
<p>ç³»ç»Ÿé»˜è®¤ä½¿ç”¨ç®¡ç†Roleçš„è§’è‰² ç®¡ç†å‘˜ç”¨æˆ·ï¼šadmin æ™®é€šç”¨æˆ·ï¼šmemberï¼ˆè€ç‰ˆæœ¬ï¼‰ userï¼ˆæ–°ç‰ˆæœ¬ï¼‰</p>

<h3 id="13openstack-dashboardè·å–å®ä¾‹å¤±è´¥é—®é¢˜åˆ›å»ºå¤±è´¥é—®é¢˜">1.3ã€openstack dashboardè·å–å®ä¾‹å¤±è´¥é—®é¢˜ã€‚åˆ›å»ºå¤±è´¥é—®é¢˜ã€‚</h3>
<p>é—®é¢˜æè¿°ï¼š<br />
dashboardè·å–å®ä¾‹å¤±è´¥é—®é¢˜ã€‚åˆ›å»ºå¤±è´¥,åŠ è½½ä¸å‡ºæ¥å®ä¾‹åˆ—è¡¨ã€‚</p>

<p>è§£å†³æ–¹æ³•ï¼š<br />
æŸ¥çœ‹äº†maridbå¾—é“¾æ¥æ•°ï¼Œå‘ç°é»˜è®¤åªæœ‰100</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MariaDB [(none)]&gt; show global variables like '%max_conn%';
+-----------------------+-------+
| Variable_name         | Value |
+-----------------------+-------+
| extra_max_connections | 1     |
| max_connect_errors    | 100   |
| max_connections       | 151   |
+-----------------------+-------+
</code></pre></div></div>

<p>1.mariadbæ•°æ®åº“æœ€å¤§è¿æ¥æ•°ï¼Œé»˜è®¤ä¸º151</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MariaDB [(none)]&gt; show variables like 'max_connections';
+-----------------+-------+
| Variable_name   | Value |
+-----------------+-------+
| max_connections |  151  |
+-----------------+-------+
</code></pre></div></div>

<p>2.é…ç½®/etc/my.cnf</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[mysqld]ä¸‹æ–°æ·»åŠ ä¸€è¡Œå¦‚ä¸‹å‚æ•°ï¼š
max_connections=8000
</code></pre></div></div>

<p>3ã€ç”±äºmariadbæœ‰é»˜è®¤æ‰“å¼€æ–‡ä»¶æ•°é™åˆ¶</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi /usr/lib/systemd/system/mariadb.service
å–æ¶ˆ[Service]å‰çš„#å·ï¼Œ
[Service]æ–°æ·»åŠ ä¸¤è¡Œå¦‚ä¸‹å‚æ•°ï¼š
LimitNOFILE=10000
LimitNPROC=10000
</code></pre></div></div>

<p>4.é‡æ–°åŠ è½½ç³»ç»ŸæœåŠ¡ï¼Œå¹¶é‡å¯mariadbæœåŠ¡</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl --system daemon-reload
systemctl restart mariadb.service
å†æ¬¡æŸ¥çœ‹mariadbæ•°æ®åº“æœ€å¤§è¿æ¥æ•°ï¼Œå¯ä»¥çœ‹åˆ°æœ€å¤§è¿æ¥æ•°å·²ç»æ˜¯3000
MariaDB [(none)]&gt; show variables like 'max_connections';
+-----------------+-------+
| Variable_name   | Value |
+-----------------+-------+
| max_connections | 8000  |
+-----------------+-------+
</code></pre></div></div>

<h3 id="13-æ‰§è¡Œopenstack-volume-service-listè¿”å›503">1.3 æ‰§è¡Œopenstack volume service listè¿”å›503</h3>
<p>æŠ¥é”™</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> openstack volume service list
The server is currently unavailable. Please try again at a later time.&lt;br /&gt;&lt;br /&gt;
The Keystone service is temporarily unavailable.

 (HTTP 503)
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REQ: curl -g -i -X GET http://controller:8776/v2/6c95ba186f1047e0a632c3cd1ab08168/os-services -H "Accept: application/json" -H "User-Agent: python-cinderclient" -H "X-Auth-Token: {SHA256}dc4f470e39c8f3d8a2517483de6a5cb3f8fe5814b845624c645c55c8d66a6d9c"
Starting new HTTP connection (1): controller:8776
http://controller:8776 "GET /v2/6c95ba186f1047e0a632c3cd1ab08168/os-services HTTP/1.1" 503 218
RESP: [503] Connection: keep-alive Content-Length: 218 Content-Type: application/json Date: Wed, 13 May 2020 02:22:51 GMT X-Openstack-Request-Id: req-b378d292-7493-4e2f-93a0-fd64c395faff
RESP BODY: {"message": "The server is currently unavailable. Please try again at a later time.&lt;br /&gt;&lt;br /&gt;\nThe Keystone service is temporarily unavailable.\n\n", "code": "503 Service Unavailable", "title": "Service Unavailable"}
GET call to volumev2 for http://controller:8776/v2/6c95ba186f1047e0a632c3cd1ab08168/os-services used request id req-b378d292-7493-4e2f-93a0-fd64c395faff
The server is currently unavailable. Please try again at a later time.&lt;br /&gt;&lt;br /&gt;
The Keystone service is temporarily unavailable.
</code></pre></div></div>

<p>é—®é¢˜æ’æŸ¥</p>
<ul>
  <li>1.ä¸€å¼€å§‹ä»¥ä¸ºæ˜¯keystoneå¾—é—®é¢˜ï¼Œè¿›è¡Œäº†keystoneå¾—æ—¥å¿—æ’æŸ¥åå‘ç°å¹¶ékeystoneå¾—é—®é¢˜ã€‚</li>
  <li>2.ä»¥ä¸ºæ˜¯httpdè½¬å‘è¯·æ±‚åˆ°keystoneè¶…æ—¶å¾—é—®é¢˜ã€‚ç»è¿‡timeæµ‹è¯•å‘ç°æ—¶é—´åªç”¨å¾—5sã€‚é»˜è®¤è¶…æ—¶æ—¶é—´15sã€‚æ‰€ä»¥ç»§ç»­ä¸‹ä¸€ä¸ªæ’æŸ¥</li>
  <li>æœ€åæ’æŸ¥äº†cinderå¾—æ—¥å¿—åˆæœ‰äº†å‘ç°æ—¥å¿—é‡Œé¢401.ä½†æ˜¯é…ç½®æ²¡é—®é¢˜ã€‚ä¸ºä»€ä¹ˆå‡ºç°è¿™ä¸ªé—®é¢˜å‘¢? ä¸Šé¢debugçœ‹çš„æ˜¯æ²¡æœ‰æˆæƒæƒé™ã€‚åé¢å¼€å§‹æ ¹æ®ç”¨æˆ·æ’æŸ¥ã€‚æœ€ç»ˆæŠŠç”¨æˆ·åˆ æ‰äº†é‡å»ºåé—®é¢˜è§£å†³ã€‚åº”è¯¥æ˜¯cinderç”¨æˆ·å¾—å¯†ç å’Œé…ç½®æ–‡ä»¶ä¸­å¾—ä¸ä¸€è‡´å¯¼æ¬¡é—®é¢˜ã€‚</li>
</ul>

<p>è§£å†³æ–¹æ³•ï¼š</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ openstack user delete cinder
$ openstack user create --domain default --password-prompt cinder
$ openstack volume service list
+------------------+-----------------+------+---------+-------+----------------------------+
| Binary           | Host            | Zone | Status  | State | Updated At                 |
+------------------+-----------------+------+---------+-------+----------------------------+
| cinder-volume    | controller@ceph | nova | enabled | up    | 2020-05-13T03:08:07.000000 |
| cinder-scheduler | controller      | nova | enabled | up    | 2020-05-13T03:08:07.000000 |
+------------------+-----------------+------+---------+-------+----------------------------+
</code></pre></div></div>

:ET