I"»†<p>ELK ä¸æ˜¯ä¸€æ¬¾è½¯ä»¶ï¼Œè€Œæ˜¯ Elasticsearchã€Logstash å’Œ Kibana ä¸‰ç§è½¯ä»¶äº§å“çš„é¦–å­—æ¯ç¼©å†™ã€‚è¿™ä¸‰è€…éƒ½æ˜¯å¼€æºè½¯ä»¶ï¼Œé€šå¸¸é…åˆä½¿ç”¨ï¼Œè€Œä¸”åˆå…ˆåå½’äº Elastic.co å…¬å¸åä¸‹ï¼Œæ‰€ä»¥è¢«ç®€ç§°ä¸º ELK Stackã€‚</p>

<h1 id="centos-7ä¸Šå®‰è£…elasticsearchlogstashå’Œkibana">CentOS 7ä¸Šå®‰è£…Elasticsearchï¼ŒLogstashå’ŒKibana</h1>

<h2 id="ä½¿ç”¨logstashå’Œkibanaåœ¨centos-7ä¸Šé›†ä¸­æ—¥å¿—è®°å½•">ä½¿ç”¨Logstashå’ŒKibanaåœ¨CentOS 7ä¸Šé›†ä¸­æ—¥å¿—è®°å½•</h2>

<blockquote>
  <p>é›†ä¸­æ—¥å¿—è®°å½•åœ¨å°è¯•è¯†åˆ«æœåŠ¡å™¨æˆ–åº”ç”¨ç¨‹åºçš„é—®é¢˜æ—¶éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºå®ƒå…è®¸æ‚¨åœ¨å•ä¸ªä½ç½®æœç´¢æ‰€æœ‰æ—¥å¿—ã€‚å®ƒä¹Ÿå¾ˆæœ‰ç”¨ï¼Œå› ä¸ºå®ƒå…è®¸æ‚¨é€šè¿‡åœ¨ç‰¹å®šæ—¶é—´èŒƒå›´å†…å…³è”å…¶æ—¥å¿—æ¥è¯†åˆ«è·¨å¤šä¸ªæœåŠ¡å™¨çš„é—®é¢˜ã€‚æœ¬ç³»åˆ—æ•™ç¨‹å°†æ•™æ‚¨å¦‚ä½•åœ¨CentOSä¸Šå®‰è£…Logstashå’ŒKibanaï¼Œç„¶åå¦‚ä½•æ·»åŠ æ›´å¤šè¿‡æ»¤å™¨æ¥æ„é€ æ‚¨çš„æ—¥å¿—æ•°æ®ã€‚
http://www.ibm.com/developerworks/cn/opensource/os-cn-elk/</p>
</blockquote>

<h2 id="å®‰è£…ä»‹ç»">å®‰è£…ä»‹ç»</h2>
<blockquote>
  <p>åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†åœ¨CentOS 7ä¸Šå®‰è£…Elasticsearch ELK Stackï¼Œå³Elasticsearch 5. xï¼ŒLogstash 5. xå’ŒKibana 5. xã€‚æˆ‘ä»¬è¿˜å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•é…ç½®å®ƒï¼Œä»¥ä½¿ç”¨Filebeat 1.åœ¨ä¸€ä¸ªé›†ä¸­çš„ä½ç½®æ”¶é›†å’Œå¯è§†åŒ–æ‚¨çš„ç³»ç»Ÿçš„ç³»ç»Ÿæ—¥å¿—ã€‚ Logstashæ˜¯ä¸€ä¸ªç”¨äºæ”¶é›†ï¼Œè§£æå’Œå­˜å‚¨æ—¥å¿—ä»¥ä¾›å°†æ¥ä½¿ç”¨çš„å¼€æºå·¥å…·ã€‚ Kibanaæ˜¯ä¸€ä¸ªWebç•Œé¢ï¼Œå¯ç”¨äºæœç´¢å’ŒæŸ¥çœ‹Logstashç´¢å¼•çš„æ—¥å¿—ã€‚è¿™ä¸¤ä¸ªå·¥å…·éƒ½åŸºäºElasticsearchï¼Œç”¨äºå­˜å‚¨æ—¥å¿—ã€‚</p>
</blockquote>

<h2 id="å®éªŒç›®çš„">å®éªŒç›®çš„</h2>
<blockquote>
  <p>æœ¬æ•™ç¨‹çš„ç›®æ ‡æ˜¯è®¾ç½®Logstashä»¥æ”¶é›†å¤šä¸ªæœåŠ¡å™¨çš„syslogï¼Œå¹¶è®¾ç½®Kibanaä»¥å¯è§†åŒ–æ”¶é›†çš„æ—¥å¿—ã€‚</p>
</blockquote>

<p><strong>ELKå †æ ˆè®¾ç½®æœ‰å››ä¸ªä¸»è¦ç»„ä»¶ï¼š</strong></p>
<ul>
  <li>Logstashï¼šå¤„ç†ä¼ å…¥æ—¥å¿—çš„Logstashçš„æœåŠ¡å™¨ç»„ä»¶</li>
  <li>Elasticsearchï¼šå­˜å‚¨æ‰€æœ‰æ—¥å¿—</li>
  <li>Kibanaï¼šç”¨äºæœç´¢å’Œå¯è§†åŒ–æ—¥å¿—çš„Webç•Œé¢ï¼Œå°†é€šè¿‡Nginx</li>
  <li>Filebeatä»£ç†ï¼šå®‰è£…åœ¨å°†å…¶æ—¥å¿—å‘é€åˆ°Logstashçš„å®¢æˆ·ç«¯æœåŠ¡å™¨ï¼ŒFilebeatå……å½“æ—¥å¿—ä¼ é€ä»£ç†ï¼Œåˆ©ç”¨ä¼æœ¨å·¥å…·ç½‘ç»œåè®®ä¸Logstashè¿›è¡Œé€šä¿¡
<img src="img/elkæ¶æ„.png" alt="" /></li>
</ul>

<blockquote>
  <p>æˆ‘ä»¬å°†åœ¨å•ä¸ªæœåŠ¡å™¨ä¸Šå®‰è£…å‰ä¸‰ä¸ªç»„ä»¶ï¼Œæˆ‘ä»¬å°†å…¶ç§°ä¸ºæˆ‘ä»¬çš„ELKæœåŠ¡å™¨ã€‚ Filebeatå°†å®‰è£…åœ¨æˆ‘ä»¬è¦æ”¶é›†æ—¥å¿—çš„æ‰€æœ‰å®¢æˆ·ç«¯æœåŠ¡å™¨ä¸Šï¼Œæˆ‘ä»¬å°†ç»Ÿç§°ä¸ºå®¢æˆ·ç«¯æœåŠ¡å™¨ã€‚</p>
</blockquote>

<h2 id="å…ˆå†³æ¡ä»¶">å…ˆå†³æ¡ä»¶</h2>
<blockquote>
  <p>æ‚¨çš„ELKæœåŠ¡å™¨å°†éœ€è¦çš„CPUï¼ŒRAMå’Œå­˜å‚¨é‡å–å†³äºæ‚¨è¦æ”¶é›†çš„æ—¥å¿—çš„å·ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å…·æœ‰ä»¥ä¸‹è§„æ ¼çš„VPSç”¨äºæˆ‘ä»¬çš„ELKæœåŠ¡å™¨ï¼š</p>
  <ul>
    <li>OS: CentOS 7</li>
    <li>RAM: 4GB</li>
    <li>CPU: 2</li>
  </ul>
</blockquote>

<blockquote>
  <p>æ³¨ï¼šæ ¹æ®è‡ªå·±çš„æœåŠ¡å™¨èµ„æºåˆ†é…å„ä¸ªèŠ‚ç‚¹çš„èµ„æº</p>
</blockquote>

<h2 id="å®‰è£…-java-8">å®‰è£… Java 8</h2>
<blockquote>
  <p>Elasticsearchå’ŒLogstashéœ€è¦Javaï¼Œæ‰€ä»¥æˆ‘ä»¬ç°åœ¨å°±å®‰è£…å®ƒã€‚æˆ‘ä»¬å°†å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„Oracle Java 8ï¼Œå› ä¸ºè¿™æ˜¯Elasticsearchæ¨èçš„ç‰ˆæœ¬ã€‚
æ³¨ï¼šå»ºè®®æœ¬åœ°ä¸‹è½½å®Œæœ€æ–°ç‰ˆçš„JDKï¼Œç„¶åä¸Šä¼ åˆ°æœåŠ¡å™¨çš„/usr/local/srcç›®å½•</p>
</blockquote>

<blockquote>
  <ol>
    <li>JDKä¸‹è½½åœ°å€ï¼š</li>
    <li>http://www.oracle.com/technetwork/java/javase/downloads</li>
  </ol>
</blockquote>

<p>ç„¶åä½¿ç”¨æ­¤yumå‘½ä»¤å®‰è£…RPMï¼ˆå¦‚æœæ‚¨ä¸‹è½½äº†ä¸åŒçš„ç‰ˆæœ¬ï¼Œè¯·åœ¨æ­¤å¤„æ›¿æ¢æ–‡ä»¶åï¼‰ï¼š</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nt">-y</span> localinstall jdk-8u111-linux-x64.rpm <span class="se">\</span>
or
rpm <span class="nt">-ivh</span> jdk-8u111-linux-x64.rpm
</code></pre></div></div>

<blockquote>
  <p>ç°åœ¨Javaåº”è¯¥å®‰è£…åœ¨/usr/java/jdk1.8.0_111/jre/bin/javaï¼Œå¹¶ä»/usr/bin/java é“¾æ¥ã€‚</p>
</blockquote>

<h2 id="å®‰è£…-elasticsearch">å®‰è£… Elasticsearch</h2>
<p>Elasticsearchå¯ä»¥é€šè¿‡æ·»åŠ Elasticçš„è½¯ä»¶åŒ…ä»“åº“ä¸è½¯ä»¶åŒ…ç®¡ç†å™¨ä¸€èµ·å®‰è£…ã€‚
è¿è¡Œä»¥ä¸‹å‘½ä»¤å°†Elasticsearchå…¬å…±GPGå¯†é’¥å¯¼å…¥rpmï¼šhttps://www.elastic.co/guide/en/elasticsearch/reference/current/rpm.html</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rpm <span class="nt">--import</span> https://artifacts.elastic.co/GPG-KEY-elasticsearch
</code></pre></div></div>
<p>åœ¨åŸºäºRedHatçš„å‘è¡Œç‰ˆçš„/etc/yum.repos.d/ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªåä¸ºelasticsearch.repoçš„æ–‡ä»¶,å…¶ä¸­åŒ…æ‹¬ï¼š</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s1">'[elasticsearch-5.x]
name=Elasticsearch repository for 5.x packages
baseurl=https://artifacts.elastic.co/packages/5.x/yum
gpgcheck=1
gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
enabled=1
autorefresh=1
type=rpm-md
| sudo tee /etc/yum.repos.d/elasticsearch.repo
</span></code></pre></div></div>

<p>Elasticsearch æºåˆ›å»ºå®Œæˆä¹‹åï¼Œé€šè¿‡makecacheæŸ¥çœ‹æºæ˜¯å¦å¯ç”¨ï¼Œç„¶åé€šè¿‡yumå®‰è£…Elasticsearch ï¼š</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum makecache
yum <span class="nb">install </span>elasticsearch <span class="nt">-y</span>
</code></pre></div></div>
<p>è¦å°†Elasticsearché…ç½®ä¸ºåœ¨ç³»ç»Ÿå¼•å¯¼æ—¶è‡ªåŠ¨å¯åŠ¨ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> /bin/systemctl daemon-reload
<span class="nb">sudo</span> /bin/systemctl <span class="nb">enable </span>elasticsearch.service
</code></pre></div></div>

<p>Elasticsearchå¯ä»¥æŒ‰å¦‚ä¸‹æ–¹å¼å¯åŠ¨å’Œåœæ­¢ï¼š</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl start elasticsearch.service
<span class="nb">sudo </span>systemctl stop elasticsearch.service
</code></pre></div></div>

<p>è¿™äº›å‘½ä»¤ä¸ä¼šæä¾›æœ‰å…³Elasticsearchæ˜¯å¦å·²æˆåŠŸå¯åŠ¨çš„åé¦ˆã€‚ç›¸åï¼Œæ­¤ä¿¡æ¯å°†å†™å…¥ä½äº/ var / log / elasticsearch /ä¸­çš„æ—¥å¿—æ–‡ä»¶ä¸­ã€‚ 
é»˜è®¤æƒ…å†µä¸‹ï¼ŒElasticsearchæœåŠ¡ä¸ä¼šè®°å½•systemdæ—¥å¿—ä¸­çš„ä¿¡æ¯ã€‚è¦å¯ç”¨journalctlæ—¥å¿—è®°å½•ï¼Œå¿…é¡»ä»elasticsearchä¸­çš„ExecStartå‘½ä»¤è¡Œä¸­åˆ é™¤â€“quieté€‰é¡¹ã€‚æœåŠ¡æ–‡ä»¶ã€‚</p>
<blockquote>
  <p>æ³¨é‡Š24è¡Œçš„ â€“quiet <br />
vim /etc/systemd/system/multi-user.target.wants/elasticsearch.service</p>
</blockquote>

<p>å½“å¯ç”¨systemdæ—¥å¿—è®°å½•æ—¶ï¼Œä½¿ç”¨journalctlå‘½ä»¤å¯ä»¥è·å¾—æ—¥å¿—è®°å½•ä¿¡æ¯ï¼š</p>
<ul>
  <li>ä½¿ç”¨tailæŸ¥çœ‹journalï¼š 
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>journalctl <span class="nt">-f</span> 
</code></pre></div>    </div>
  </li>
  <li>è¦åˆ—å‡ºelasticsearchæœåŠ¡çš„æ—¥è®°å¸åˆ†å½•ï¼š
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>journalctl <span class="nt">--unit</span> elasticsearch
</code></pre></div>    </div>
  </li>
  <li>è¦ä»ç»™å®šæ—¶é—´å¼€å§‹åˆ—å‡ºelasticsearchæœåŠ¡çš„æ—¥è®°å¸åˆ†å½•ï¼š
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>journalctl <span class="nt">--unit</span> elasticsearch <span class="nt">--since</span>  <span class="s2">"2017-1-4 10:17:16"</span> <span class="se">\</span>
since è¡¨ç¤ºæŒ‡å®šæ—¶é—´ä¹‹å‰çš„è®°å½•
</code></pre></div>    </div>
  </li>
</ul>

<blockquote>
  <p>ä½¿ç”¨man journalctl æŸ¥çœ‹journalctl æ›´å¤šä½¿ç”¨æ–¹æ³•</p>
</blockquote>

<h2 id="æ£€æŸ¥elasticsearchæ˜¯å¦æ­£åœ¨è¿è¡Œ">æ£€æŸ¥Elasticsearchæ˜¯å¦æ­£åœ¨è¿è¡Œ</h2>
<blockquote>
  <p>æ‚¨å¯ä»¥é€šè¿‡å‘localhostä¸Šçš„ç«¯å£9200å‘é€HTTPè¯·æ±‚æ¥æµ‹è¯•ElasticsearchèŠ‚ç‚¹æ˜¯å¦æ­£åœ¨è¿è¡Œï¼š</p>
  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-XGET</span> <span class="s1">'localhost:9200/?pretty'</span>
</code></pre></div>  </div>
  <p>æˆ‘ä»¬èƒ½å¾—åˆ°ä¸‹é¢è¿™æ ·çš„å›æ˜¾ï¼š</p>
  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">{</span>
  <span class="s2">"name"</span> : <span class="s2">"De-LRNO"</span>,
  <span class="s2">"cluster_name"</span> : <span class="s2">"elasticsearch"</span>,
  <span class="s2">"cluster_uuid"</span> : <span class="s2">"DeJzplWhQQK5uGitXr8jjA"</span>,
  <span class="s2">"version"</span> : <span class="o">{</span>
    <span class="s2">"number"</span> : <span class="s2">"5.1.1"</span>,
    <span class="s2">"build_hash"</span> : <span class="s2">"5395e21"</span>,
    <span class="s2">"build_date"</span> : <span class="s2">"2016-12-06T12:36:15.409Z"</span>,
    <span class="s2">"build_snapshot"</span> : <span class="nb">false</span>,
    <span class="s2">"lucene_version"</span> : <span class="s2">"6.3.0"</span>
  <span class="o">}</span>,
  <span class="s2">"tagline"</span> : <span class="s2">"You Know, for Search"</span>
<span class="o">}</span>
</code></pre></div>  </div>
</blockquote>

<h2 id="é…ç½®-elasticsearch">é…ç½® Elasticsearch</h2>
<blockquote>
  <p>Elasticsearch ä»é»˜è®¤çš„/etc/elasticsearch/elasticsearch.ymlåŠ è½½é…ç½®æ–‡ä»¶ï¼Œ 
é…ç½®æ–‡ä»¶çš„æ ¼å¼è€ƒï¼š 
https://www.elastic.co/guide/en/elasticsearch/reference/current/settings.html</p>
  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@linuxprobe ~]# egrep <span class="nt">-v</span> <span class="s2">"^#|^$"</span> /etc/elasticsearch/elasticsearch.yml 
<span class="o">[</span>root@linuxprobe ~]# egrep <span class="nt">-v</span> <span class="s2">"^#|^$"</span> /etc/elasticsearch/elasticsearch.yml
node.name: node-1
path.data: /var/lib/elasticsearch
path.logs: /var/log/elasticsearch
network.host: 10.1.1.53  <span class="c"># é»˜è®¤localhostï¼Œè‡ªå®šä¹‰ä¸ºip</span>
http.port: 9200
</code></pre></div>  </div>
  <p>RPMè¿˜å…·æœ‰ç³»ç»Ÿé…ç½®æ–‡ä»¶ï¼ˆ/etc/sysconfig/elasticsearchï¼‰ï¼Œå…è®¸æ‚¨è®¾ç½®ä»¥ä¸‹å‚æ•°ï¼š</p>
  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@linuxprobe elasticsearch]# egrep <span class="nt">-v</span> <span class="s2">"^#|^$"</span> /etc/sysconfig/elasticsearch 
<span class="nv">ES_HOME</span><span class="o">=</span>/usr/share/elasticsearch
<span class="nv">JAVA_HOME</span><span class="o">=</span>/usr/java/jdk1.8.0_111
<span class="nv">CONF_DIR</span><span class="o">=</span>/etc/elasticsearch
<span class="nv">DATA_DIR</span><span class="o">=</span>/var/lib/elasticsearch
<span class="nv">LOG_DIR</span><span class="o">=</span>/var/log/elasticsearch
<span class="nv">PID_DIR</span><span class="o">=</span>/var/run/elasticsearch
</code></pre></div>  </div>
</blockquote>

<h2 id="æ—¥å¿—é…ç½®">æ—¥å¿—é…ç½®</h2>
<blockquote>
  <p>Elasticsearchä½¿ç”¨Log4j 2è¿›è¡Œæ—¥å¿—è®°å½•ã€‚ Log4j 2å¯ä»¥ä½¿ç”¨log4j2é…ç½®ã€‚å±æ€§æ–‡ä»¶ã€‚ Elasticsearchå…¬å¼€å•ä¸ªå±æ€§$ {sysï¼šesã€‚æ—¥å¿—}ï¼Œå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­å¼•ç”¨ä»¥ç¡®å®šæ—¥å¿—æ–‡ä»¶çš„ä½ç½®;è¿™å°†åœ¨è¿è¡Œæ—¶è§£æä¸ºElasticsearchæ—¥å¿—æ–‡ä»¶çš„å‰ç¼€ã€‚
ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨çš„æ—¥å¿—ç›®å½•æ˜¯/var/log/elasticsearchå¹¶ä¸”æ‚¨çš„é›†ç¾¤åä¸ºproductionï¼Œé‚£ä¹ˆ$ {sysï¼šesã€‚ logs}å°†è§£æä¸º/var/log/elasticsearch/productionã€‚
é»˜è®¤æ—¥å¿—é…ç½®å­˜åœ¨ï¼š/etc/elasticsearch/log4j2.properties</p>
</blockquote>

<h2 id="å®‰è£…-kibana">å®‰è£… Kibana</h2>
<blockquote>
  <p>Kibanaçš„RPMå¯ä»¥ä»ELKå®˜ç½‘æˆ–ä»RPMå­˜å‚¨åº“ä¸‹è½½ã€‚å®ƒå¯ç”¨äºåœ¨ä»»ä½•åŸºäºRPMçš„ç³»ç»Ÿï¼ˆå¦‚OpenSuSEï¼ŒSLESï¼ŒCentosï¼ŒRed Hatå’ŒOracle Enterpriseï¼‰ä¸Šå®‰è£…Kibanaã€‚</p>
</blockquote>

<h2 id="å¯¼å…¥elastic-pgp-key">å¯¼å…¥Elastic PGP Key</h2>
<blockquote>
  <p>æˆ‘ä»¬ä½¿ç”¨å¼¹æ€§ç­¾åå¯†é’¥ï¼ˆPGPå¯†é’¥D88E42B4ï¼Œå¯ä»https://pgp.mit.eduï¼‰ç­¾åæ‰€æœ‰çš„åŒ…ï¼ŒæŒ‡çº¹ï¼š</p>
</blockquote>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rpm <span class="nt">--import</span> https://artifacts.elastic.co/GPG-KEY-elasticsearch
</code></pre></div></div>

<blockquote>
  <p>åˆ›å»ºkibanaæº</p>
</blockquote>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s1">'[kibana-5.x]
name=Kibana repository for 5.x packages
baseurl=https://artifacts.elastic.co/packages/5.x/yum
gpgcheck=1
gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
enabled=1
autorefresh=1
type=rpm-md
'</span> | <span class="nb">sudo tee</span> /etc/yum.repos.d/kibana.repo
</code></pre></div></div>

<blockquote>
  <p>kibanaæºåˆ›å»ºæˆåŠŸä¹‹åï¼Œmakecacheåä½¿ç”¨yumå®‰è£…kibanaï¼š</p>
  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum makecache <span class="o">&amp;&amp;</span> yum <span class="nb">install </span>kibana <span class="nt">-y</span>
</code></pre></div>  </div>
</blockquote>

<h2 id="ä½¿ç”¨systemdè¿è¡Œkibana">ä½¿ç”¨systemdè¿è¡ŒKibana</h2>
<blockquote>
  <p>è¦å°†Kibanaé…ç½®ä¸ºåœ¨ç³»ç»Ÿå¼•å¯¼æ—¶è‡ªåŠ¨å¯åŠ¨ï¼Œè¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> /bin/systemctl daemon-reload
<span class="nb">sudo</span> /bin/systemctl <span class="nb">enable </span>kibana.service
</code></pre></div>  </div>
  <p>Kibanaå¯ä»¥å¦‚ä¸‹å¯åŠ¨å’Œåœæ­¢</p>
  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl start kibana.service
<span class="nb">sudo </span>systemctl stop kibana.service
</code></pre></div>  </div>
</blockquote>

<h2 id="é…ç½®kibana">é…ç½®Kibana</h2>
<blockquote>
  <p>Kibanaé»˜è®¤ä»/etc/kibana/kibana.ymlæ–‡ä»¶åŠ è½½å…¶é…ç½®ã€‚ <br />
å‚è€ƒï¼šhttps://www.elastic.co/guide/en/kibana/current/settings.html<br />
æ³¨æ„ï¼šæœ¬å®éªŒæ•™ç¨‹æŠŠlocalhostéƒ½æ”¹æˆæœåŠ¡å™¨IPï¼Œå¦‚æœä¸æ›´æ”¹localhostï¼Œéœ€è¦è®¾ç½®åå‘ä»£ç†æ‰èƒ½è®¿é—®åˆ°kibanaã€‚</p>
</blockquote>

<h2 id="å®‰è£…nginx">å®‰è£…nginx</h2>
<blockquote>
  <p>é…ç½®Kibanaåœ¨localhostä¸Šç›‘å¬ï¼Œå¿…é¡»è®¾ç½®ä¸€ä¸ªåå‘ä»£ç†ï¼Œå…è®¸å¤–éƒ¨è®¿é—®å®ƒã€‚æœ¬æ–‡ä½¿ç”¨Nginxæ¥å®ç°å‘å‘ä»£ç†ã€‚</p>
</blockquote>

<p>åˆ›å»ºnginxå®˜æ–¹æºæ¥å®‰è£…nginx
https://www.nginx.com/resources/wiki/start/topics/tutorials/install/</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s1">'[nginx]
name=nginx repo
baseurl=http://nginx.org/packages/centos/$releasever/$basearch/
gpgcheck=0
enabled=1
'</span> | <span class="nb">sudo tee</span> /etc/yum.repos.d/nginx.repo
</code></pre></div></div>
<p>ä½¿ç”¨yumå®‰è£…nginxå’Œhttpd-tools</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum <span class="nb">install </span>nginx httpd-tools <span class="nt">-y</span>
</code></pre></div></div>

<p>ä½¿ç”¨htpasswdåˆ›å»ºä¸€ä¸ªåä¸ºâ€œkibanaadminâ€çš„ç®¡ç†å‘˜ç”¨æˆ·ï¼ˆå¯ä»¥ä½¿ç”¨å…¶ä»–åç§°ï¼‰ï¼Œè¯¥ç”¨æˆ·å¯ä»¥è®¿é—®Kibana Webç•Œé¢ï¼š</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@linuxprobe ~]# htpasswd <span class="nt">-c</span> /etc/nginx/htpasswd.users kibanaadmin
New password:              <span class="c"># è‡ªå®šä¹‰</span>
Re-type new password: 
Adding password <span class="k">for </span>user kibanaadmin
</code></pre></div></div>

<p>ä½¿ç”¨vimé…ç½®nginxé…ç½®æ–‡ä»¶</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@linuxprobe ~]# egrep <span class="nt">-v</span> <span class="s2">"#|^$"</span> /etc/nginx/conf.d/kibana.conf 
server <span class="o">{</span>
    listen       80<span class="p">;</span>
    server_name  kibana.aniu.co<span class="p">;</span>
    access_log  /var/log/nginx/kibana.aniu.co.access.log main<span class="p">;</span>
    error_log   /var/log/nginx/kibana.aniu.co.access.log<span class="p">;</span>
    auth_basic <span class="s2">"Restricted Access"</span><span class="p">;</span>
    auth_basic_user_file /etc/nginx/htpasswd.users<span class="p">;</span>
    location / <span class="o">{</span>
        proxy_pass http://localhost:5601<span class="p">;</span>
        proxy_http_version 1.1<span class="p">;</span>
        proxy_set_header Upgrade <span class="nv">$http_upgrade</span><span class="p">;</span>
        proxy_set_header Connection <span class="s1">'upgrade'</span><span class="p">;</span>
        proxy_set_header Host <span class="nv">$host</span><span class="p">;</span>
        proxy_cache_bypass <span class="nv">$http_upgrade</span><span class="p">;</span>        
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>ä¿å­˜å¹¶é€€å‡ºã€‚è¿™å°†é…ç½®Nginxå°†æ‚¨çš„æœåŠ¡å™¨çš„HTTPæµé‡å®šå‘åˆ°åœ¨æœ¬åœ°ä¸»æœº5601ä¸Šä¾¦å¬çš„Kibanaåº”ç”¨ç¨‹åºã€‚æ­¤å¤–ï¼ŒNginxå°†ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰åˆ›å»ºçš„htpasswd.usersæ–‡ä»¶ï¼Œå¹¶éœ€è¦åŸºæœ¬èº«ä»½éªŒè¯ã€‚</p>

<h2 id="å¯åŠ¨nginxå¹¶éªŒè¯é…ç½®">å¯åŠ¨nginxå¹¶éªŒè¯é…ç½®</h2>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl start nginx
<span class="nb">sudo </span>systemctl <span class="nb">enable </span>nginx
</code></pre></div></div>
<blockquote>
  <p>SELinuxå·²ç¦ç”¨ã€‚å¦‚æœä¸æ˜¯è¿™æ ·ï¼Œæ‚¨å¯èƒ½éœ€è¦è¿è¡Œä»¥ä¸‹å‘½ä»¤ä½¿Kibanaæ­£å¸¸å·¥ä½œï¼š</p>
  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>setsebool <span class="nt">-P</span> httpd_can_network_connect 1
</code></pre></div>  </div>
  <p>è®¿é—®kibanaï¼Œè¾“å…¥ä¸Šé¢è®¾ç½®çš„kibanaadmin, password
<img src="img/kibana.png" alt="kibana" /></p>
</blockquote>

<blockquote>
  <p>ä¸Šå›¾å¯ä»¥çœ‹å‡ºkibanaå·²ç»å®‰è£…æˆåŠŸï¼Œéœ€è¦é…ç½®ä¸€ä¸ª ç´¢å¼•æ¨¡å¼</p>
</blockquote>

<h2 id="å®‰è£…logstash">å®‰è£…Logstash</h2>

<h2 id="åˆ›å»ºlogstashæº">åˆ›å»ºLogstashæº</h2>

<blockquote>
  <p>å¯¼å…¥å…¬å…±ç­¾åå¯†é’¥</p>
  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rpm <span class="nt">--import</span> https://artifacts.elastic.co/GPG-KEY-elasticsearch
</code></pre></div>  </div>
  <p>å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°å…·æœ‰.repoåç¼€çš„æ–‡ä»¶ä¸­çš„/etc/yum.repos.d/ç›®å½•ä¸­ï¼Œå¦‚logstash.repo</p>
  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s1">'[logstash-5.x]
name=Elastic repository for 5.x packages
baseurl=https://artifacts.elastic.co/packages/5.x/yum
gpgcheck=1
gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
enabled=1
autorefresh=1
type=rpm-md
'</span> | <span class="nb">sudo tee</span> /etc/yum.repos.d/logstash.repo
</code></pre></div>  </div>
</blockquote>

<blockquote>
  <p>ä½¿ç”¨yumå®‰è£…logstash</p>
  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum makecache <span class="o">&amp;&amp;</span> yum <span class="nb">install </span>logstash <span class="nt">-y</span>
</code></pre></div>  </div>
  <p>ç”ŸæˆSSLè¯ä¹¦
ç”±äºæˆ‘ä»¬å°†ä½¿ç”¨Filebeatå°†æ—¥å¿—ä»æˆ‘ä»¬çš„å®¢æˆ·ç«¯æœåŠ¡å™¨å‘é€åˆ°æˆ‘ä»¬çš„ELKæœåŠ¡å™¨ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªSSLè¯ä¹¦å’Œå¯†é’¥å¯¹ã€‚ Filebeatä½¿ç”¨è¯¥è¯ä¹¦æ¥éªŒè¯ELK Serverçš„èº«ä»½ã€‚ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºå°†å­˜å‚¨è¯ä¹¦å’Œç§é’¥çš„ç›®å½•ï¼š
ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼ˆåœ¨ELKæœåŠ¡å™¨çš„FQDNä¸­æ›¿æ¢ï¼‰åœ¨é€‚å½“çš„ä½ç½®ï¼ˆ/etc/pki/tls/ â€¦ï¼‰ä¸­ç”ŸæˆSSLè¯ä¹¦å’Œç§é’¥ï¼š</p>
  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /etc/pki/tls
<span class="nb">sudo </span>openssl req <span class="nt">-subj</span> <span class="s1">'/CN=ELK_server_fqdn/'</span> <span class="nt">-x509</span> <span class="nt">-days</span> 3650 <span class="nt">-batch</span> <span class="nt">-nodes</span> <span class="nt">-newkey</span> rsa:2048 <span class="nt">-keyout</span> private/logstash-forwarder.key <span class="nt">-out</span> certs/logstash-forwarder.crt
</code></pre></div>  </div>
</blockquote>

<blockquote>
  <p>æ³¨ï¼šELK_server_fqdnè‡ªå®šä¹‰ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@linuxprobe ~]# <span class="nb">cd</span> /etc/pki/tls
<span class="o">[</span>root@linuxprobe tls]# <span class="nb">sudo </span>openssl req <span class="nt">-subj</span> <span class="s1">'/CN=kibana.aniu.co/'</span> <span class="nt">-x509</span> <span class="nt">-days</span> 3650 <span class="nt">-batch</span> <span class="nt">-nodes</span> <span class="nt">-newkey</span> rsa:2048 <span class="nt">-keyout</span> private/logstash-forwarder.key <span class="nt">-out</span> certs/logstash-forwarder.crt
Generating a 2048 bit RSA private key
.+++
...........................................................................................................+++
writing new private key to <span class="s1">'private/logstash-forwarder.key'</span>
</code></pre></div>  </div>
  <p>logstash-forwarder.crtæ–‡ä»¶å°†è¢«å¤åˆ¶åˆ°ï¼Œæ‰€æœ‰å°†æ—¥å¿—å‘é€åˆ°Logstashçš„æœåŠ¡å™¨</p>
</blockquote>

<h2 id="é…ç½®logstash">é…ç½®Logstash</h2>
<blockquote>
  <p>Logstashé…ç½®æ–‡ä»¶ä¸ºJSONæ ¼å¼ï¼Œé©»ç•™åœ¨/etc/logstash/conf.dä¸­ã€‚è¯¥é…ç½®ç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼šè¾“å…¥ï¼Œè¿‡æ»¤å’Œè¾“å‡ºã€‚</p>
</blockquote>

<ol>
  <li>åˆ›å»ºä¸€ä¸ªåä¸º01-beats-input.confçš„é…ç½®æ–‡ä»¶ï¼Œå¹¶è®¾ç½®æˆ‘ä»¬çš„â€œfilebeatâ€è¾“å…¥ï¼š
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>vi /etc/logstash/conf.d/01-beats-input.conf
</code></pre></div>    </div>
    <p>æ’å…¥ä»¥ä¸‹è¾“å…¥é…ç½®</p>
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>input <span class="o">{</span>
  beats <span class="o">{</span>
 port <span class="o">=&gt;</span> 5044
 ssl <span class="o">=&gt;</span> <span class="nb">true
 </span>ssl_certificate <span class="o">=&gt;</span> <span class="s2">"/etc/pki/tls/certs/logstash-forwarder.crt"</span>
 ssl_key <span class="o">=&gt;</span> <span class="s2">"/etc/pki/tls/private/logstash-forwarder.key"</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
    <blockquote>
      <p>ä¿å­˜é€€å‡ºï¼Œç›‘å¬TCP 5044ç«¯å£ä¸Šbeats è¾“å…¥ï¼Œä½¿ç”¨ä¸Šé¢åˆ›å»ºçš„SSLè¯ä¹¦åŠ å¯†</p>
    </blockquote>
  </li>
  <li>åˆ›å»ºä¸€ä¸ªåä¸º10-syslog-filter.confçš„é…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬å°†ä¸ºsyslogæ¶ˆæ¯æ·»åŠ ä¸€ä¸ªè¿‡æ»¤å™¨ï¼š
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>vim /etc/logstash/conf.d/10-syslog-filter.conf
æ’å…¥ä»¥ä¸‹è¾“å…¥é…ç½®
filter <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span><span class="nb">type</span><span class="o">]</span> <span class="o">==</span> <span class="s2">"syslog"</span> <span class="o">{</span>
 grok <span class="o">{</span>
   match <span class="o">=&gt;</span> <span class="o">{</span> <span class="s2">"message"</span> <span class="o">=&gt;</span> <span class="s2">"%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:syslog_hostname} %{DATA:syslog_program}(?:</span><span class="se">\[</span><span class="s2">%{POSINT:syslog_pid}</span><span class="se">\]</span><span class="s2">)?: %{GREEDYDATA:syslog_message}"</span> <span class="o">}</span>
   add_field <span class="o">=&gt;</span> <span class="o">[</span> <span class="s2">"received_at"</span>, <span class="s2">"%{@timestamp}"</span> <span class="o">]</span>
   add_field <span class="o">=&gt;</span> <span class="o">[</span> <span class="s2">"received_from"</span>, <span class="s2">"%{host}"</span> <span class="o">]</span>
 <span class="o">}</span>
 syslog_pri <span class="o">{</span> <span class="o">}</span>
 <span class="nb">date</span> <span class="o">{</span>
   match <span class="o">=&gt;</span> <span class="o">[</span> <span class="s2">"syslog_timestamp"</span>, <span class="s2">"MMM  d HH:mm:ss"</span>, <span class="s2">"MMM dd HH:mm:ss"</span> <span class="o">]</span>
 <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
    <blockquote>
      <p>saveå’Œquitã€‚æ­¤è¿‡æ»¤å™¨æŸ¥æ‰¾æ ‡è®°ä¸ºâ€œsyslogâ€ç±»å‹ï¼ˆç”±Filebeatï¼‰çš„æ—¥å¿—ï¼Œå¹¶ä¸”å°†å°è¯•ä½¿ç”¨grokè§£æä¼ å…¥çš„syslogæ—¥å¿—ï¼Œä»¥ä½¿å…¶ç»“æ„åŒ–å’Œå¯æŸ¥è¯¢ã€‚</p>
    </blockquote>
  </li>
  <li>åˆ›å»ºä¸€ä¸ªåä¸ºlogstash-simpleçš„é…ç½®æ–‡ä»¶,ç¤ºä¾‹æ–‡ä»¶ï¼š
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim /etc/logstash/conf.d/logstash-simple.conf
æ’å…¥ä»¥ä¸‹è¾“å…¥é…ç½®
input <span class="o">{</span> stdin <span class="o">{</span> <span class="o">}</span> <span class="o">}</span>
output <span class="o">{</span>
  elasticsearch <span class="o">{</span> hosts <span class="o">=&gt;</span> <span class="o">[</span><span class="s2">"localhost:9200"</span><span class="o">]</span> <span class="o">}</span>
  stdout <span class="o">{</span> codec <span class="o">=&gt;</span> rubydebug <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ol>

<blockquote>
  <p>è¿™ä¸ªè¾“å‡ºåŸºæœ¬ä¸Šé…ç½®Logstashæ¥å­˜å‚¨inputæ•°æ®åˆ°Elasticsearchä¸­ï¼Œè¿è¡Œåœ¨localhostï¼š9200</p>
</blockquote>

<ol>
  <li>è¿è¡ŒLogstashä½¿ç”¨Systemd
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl start logstash.service
<span class="nb">sudo </span>systemctl <span class="nb">enable </span>logstash.service
</code></pre></div>    </div>
    <blockquote>
      <p>æ³¨ï¼š åˆ°è¿™é‡Œå¯èƒ½ä¼šå‡ºç°Logstashé‡å¯å¤±è´¥ï¼Œç­‰é—®é¢˜ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼Œé”å®šå…·ä½“é—®é¢˜ï¼Œä¸€èˆ¬ä¸ä¼šå‡ºé”™</p>
    </blockquote>
  </li>
</ol>

<h2 id="åŠ è½½kibanaä»ªè¡¨æ¿">åŠ è½½Kibanaä»ªè¡¨æ¿</h2>
<blockquote>
  <p>Elasticæä¾›äº†å‡ ä¸ªæ ·ä¾‹Kibanaä»ªè¡¨æ¿å’ŒBeatsç´¢å¼•æ¨¡å¼ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¼€å§‹ä½¿ç”¨Kibanaã€‚è™½ç„¶æˆ‘ä»¬ä¸ä¼šåœ¨æœ¬æ•™ç¨‹ä¸­ä½¿ç”¨ä»ªè¡¨æ¿ï¼Œæˆ‘ä»¬ä»å°†åŠ è½½å®ƒä»¬ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒåŒ…æ‹¬çš„Filebeatç´¢å¼•æ¨¡å¼ã€‚<br />
é¦–å…ˆï¼Œå°†ç¤ºä¾‹ä»ªè¡¨æ¿å½’æ¡£ä¸‹è½½åˆ°æ‚¨çš„ä¸»ç›®å½•ï¼š</p>
  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /usr/local/src
curl <span class="nt">-L</span> <span class="nt">-O</span> https://download.elastic.co/beats/dashboards/beats-dashboards-1.1.0.zip
</code></pre></div>  </div>
</blockquote>

<ol>
  <li>å®‰è£…unzipåŒ…ï¼Œè§£å‹beats
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>yum <span class="nt">-y</span> <span class="nb">install </span>unzip
unzip beats-dashboards-<span class="k">*</span>.zip
./load.sh
</code></pre></div>    </div>
  </li>
</ol>

<blockquote>
  <p>è¿™äº›æ˜¯æˆ‘ä»¬åˆšåŠ è½½çš„ç´¢å¼•æ¨¡å¼ï¼š</p>
  <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">[</span><span class="nv">packetbeat-</span><span class="pi">]</span><span class="s">YYYY.MM.DD</span>
<span class="pi">[</span><span class="nv">topbeat-</span><span class="pi">]</span><span class="s">YYYY.MM.DD</span>
<span class="pi">[</span><span class="nv">filebeat-</span><span class="pi">]</span><span class="s">YYYY.MM.DD</span>
<span class="pi">[</span><span class="nv">winlogbeat-</span><span class="pi">]</span><span class="s">YYYY.MM.DD</span>
</code></pre></div>  </div>
  <p>æˆ‘ä»¬å¼€å§‹ä½¿ç”¨Kibanaæ—¶ï¼Œæˆ‘ä»¬å°†é€‰æ‹©Filebeatç´¢å¼•æ¨¡å¼ä½œä¸ºé»˜è®¤å€¼ã€‚</p>
</blockquote>

<h2 id="åœ¨elasticsearchä¸­åŠ è½½filebeatç´¢å¼•æ¨¡æ¿">åœ¨Elasticsearchä¸­åŠ è½½Filebeatç´¢å¼•æ¨¡æ¿</h2>
<blockquote>
  <p>å› ä¸ºæˆ‘ä»¬è®¡åˆ’ä½¿ç”¨Filebeatå°†æ—¥å¿—å‘é€åˆ°Elasticsearchï¼Œæˆ‘ä»¬åº”è¯¥åŠ è½½Filebeatç´¢å¼•æ¨¡æ¿ã€‚ç´¢å¼•æ¨¡æ¿å°†é…ç½®Elasticsearchä»¥æ™ºèƒ½æ–¹å¼åˆ†æä¼ å…¥çš„Filebeatå­—æ®µã€‚<br />
é¦–å…ˆï¼Œå°†Filebeatç´¢å¼•æ¨¡æ¿ä¸‹è½½åˆ°æ‚¨çš„ä¸»ç›®å½•ï¼š</p>
  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /usr/local/src
curl <span class="nt">-O</span> https://gist.githubusercontent.com/thisismitch/3429023e8438cc25b86c/raw/d8c479e2a1adcea8b1fe86570e42abab0f10f364/filebeat-index-template.json
</code></pre></div>  </div>
  <p>ç„¶åä½¿ç”¨æ­¤å‘½ä»¤åŠ è½½æ¨¡æ¿ï¼š<br />
æ³¨ï¼šæ‰§è¡Œå‘½ä»¤çš„ä½ç½®å’Œjsonæ¨¡æ¿ç›¸åŒ</p>
  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@linuxprobe src]# curl <span class="nt">-XPUT</span> <span class="s1">'http://localhost:9200/_template/filebeat?pretty'</span> <span class="nt">-d</span>@filebeat-index-template.json
<span class="o">{</span>
  <span class="s2">"acknowledged"</span> : <span class="nb">true</span>
<span class="o">}</span>
</code></pre></div>  </div>
  <p>ç°åœ¨æˆ‘ä»¬çš„ELKæœåŠ¡å™¨å·²å‡†å¤‡å¥½æ¥æ”¶Filebeatæ•°æ®ï¼Œç§»åŠ¨åˆ°åœ¨æ¯ä¸ªå®¢æˆ·ç«¯æœåŠ¡å™¨ä¸Šè®¾ç½®Filebeatã€‚</p>
</blockquote>

<h2 id="è®¾ç½®filebeatæ·»åŠ å®¢æˆ·ç«¯æœåŠ¡å™¨">è®¾ç½®Filebeatï¼ˆæ·»åŠ å®¢æˆ·ç«¯æœåŠ¡å™¨ï¼‰</h2>
<blockquote>
  <p>å¯¹äºè¦å°†æ—¥å¿—å‘é€åˆ°ELKæœåŠ¡å™¨çš„æ¯ä¸ªCentOSæˆ–RHEL 7æœåŠ¡å™¨ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ã€‚</p>
</blockquote>

<ol>
  <li>å¤åˆ¶sslè¯ä¹¦
åœ¨ELKæœåŠ¡å™¨ä¸Šï¼Œå°†å…ˆå†³æ¡ä»¶æ•™ç¨‹ä¸­åˆ›å»ºçš„SSLè¯ä¹¦å¤åˆ¶åˆ°å®¢æˆ·ç«¯æœåŠ¡å™¨ï¼š
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ä½¿ç”¨SCPè¿œç¨‹å®ç°å¤åˆ¶
yum <span class="nt">-y</span> <span class="nb">install </span>openssh-clinets
scp /etc/pki/tls/certs/logstash-forwarder.crt root@linux-node1:/tmp
</code></pre></div>    </div>
  </li>
</ol>

<blockquote>
  <p>æ³¨ï¼šå¦‚æœä¸é€‚ç”¨ipï¼Œè®°å¾—åœ¨ELKæœåŠ¡å™¨ä¸Šè®¾ç½®hosts</p>
</blockquote>

<blockquote>
  <p>åœ¨æä¾›æ‚¨çš„ç™»å½•å‡­æ®åï¼Œè¯·ç¡®ä¿è¯ä¹¦å¤åˆ¶æˆåŠŸã€‚å®ƒæ˜¯å®¢æˆ·ç«¯æœåŠ¡å™¨å’ŒELKæœåŠ¡å™¨ä¹‹é—´çš„é€šä¿¡æ‰€å¿…éœ€çš„,åœ¨å®¢æˆ·ç«¯æœåŠ¡å™¨ä¸Šï¼Œå°†ELKæœåŠ¡å™¨çš„SSLè¯ä¹¦å¤åˆ¶åˆ°é€‚å½“çš„ä½ç½®ï¼ˆ/etc/pki/tls/certsï¼‰:</p>
  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>root@linux-node1 ~]# <span class="nb">sudo mkdir</span> <span class="nt">-p</span> /etc/pki/tls/certs
<span class="o">[</span>root@linux-node1 ~]# <span class="nb">sudo cp</span> /tmp/logstash-forwarder.crt /etc/pki/tls/certs/
</code></pre></div>  </div>
</blockquote>

<h2 id="å®‰è£…filebeatåŒ…">å®‰è£…FilebeatåŒ…</h2>
<blockquote>
  <p>åœ¨å®¢æˆ·ç«¯æœåŠ¡å™¨ä¸Šï¼Œåˆ›å»ºè¿è¡Œä»¥ä¸‹å‘½ä»¤å°†Elasticsearchå…¬ç”¨GPGå¯†é’¥å¯¼å…¥rpmï¼šå‚è€ƒä¸Šé¢ï¼š</p>
  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>rpm <span class="nt">--import</span> http://packages.elastic.co/GPG-KEY-elasticsearch
<span class="nb">echo</span> <span class="s1">'[elasticsearch-5.x]
name=Elasticsearch repository for 5.x packages
baseurl=https://artifacts.elastic.co/packages/5.x/yum
gpgcheck=1
gpgkey=https://artifacts.elastic.co/GPG-KEY-elasticsearch
enabled=1
autorefresh=1
type=rpm-md
'</span> | <span class="nb">sudo tee</span> /etc/yum.repos.d/elasticsearch.repo
</code></pre></div>  </div>
  <p>æºåˆ›å»ºå®Œæˆä¹‹åä½¿ç”¨yumå®‰è£…filebeat</p>
  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>yum makecache <span class="o">&amp;&amp;</span> yum <span class="nb">install </span>filebeat <span class="nt">-y</span>
<span class="nb">sudo </span>chkconfig <span class="nt">--add</span> filebeat
</code></pre></div>  </div>
  <h2 id="é…ç½®filebeat">é…ç½®filebeat</h2>
  <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">[</span><span class="nv">root@linux-node1 ~</span><span class="pi">]</span><span class="c1"># egrep -v "#|^$" /etc/filebeat/filebeat.yml </span>
<span class="s">filebeat.prospectors</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">input_type</span><span class="pi">:</span> <span class="s">log</span>
  <span class="na">paths</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">/var/log/secure</span>         <span class="c1"># æ–°å¢</span>
    <span class="pi">-</span> <span class="s">/var/log/messages</span>       <span class="c1"># æ–°å¢</span>
    <span class="pi">-</span> <span class="s">/var/log/*.log</span>
<span class="s">output.elasticsearch</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">localhost:9200"</span><span class="pi">]</span>
<span class="s">output.logstash</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">kibana.aniu.co:5044"</span><span class="pi">]</span>   <span class="c1"># ä¿®æ”¹ä¸ºELKä¸ŠLogstashçš„è¿æ¥æ–¹å¼</span>
  <span class="s">ssl.certificate_authorities</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">/etc/pki/tls/certs/logstash-forwarder.crt"</span><span class="pi">]</span> <span class="c1"># æ–°å¢</span>
</code></pre></div>  </div>
  <p>Filebeatçš„é…ç½®æ–‡ä»¶æ˜¯YAMLæ ¼å¼çš„ï¼Œæ³¨æ„ç¼©è¿›</p>
</blockquote>

<h2 id="å¯åŠ¨filebeat">å¯åŠ¨filebeat</h2>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl start filebeat
<span class="nb">sudo </span>systemctl <span class="nb">enable </span>filebeat
</code></pre></div></div>
<blockquote>
  <p>æ³¨ï¼šå®¢æˆ·ç«¯å‰ææ˜¯å·²ç»é…ç½®å®ŒæˆelasticsearchæœåŠ¡ï¼Œå¹¶ä¸”è®¾ç½®å¥½åŸŸåè§£æ 
filebeatå¯åŠ¨å®Œæˆåï¼Œå¯ä»¥è§‚å¯ŸELKä¸Šé¢çš„journalctl -få’Œlogstashï¼Œä»¥åŠå®¢æˆ·ç«¯çš„filebeatæ—¥å¿—ï¼ŒæŸ¥çœ‹filebeatæ˜¯å¦ç”Ÿæ•ˆ</p>
</blockquote>

<blockquote>
  <p>è¿æ¥Kibana<br />
å‚è€ƒå®˜æ–¹æ–‡æ¡£è®¾ç½®ï¼š 
https://www.elastic.co/guide/en/kibana/5.x/index.html</p>
</blockquote>

<p><img src="img/kibana1.png" alt="kibana" /></p>
:ET